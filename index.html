<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéÑ Christmas Trivia Party Game</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#04162a; --bg2:#0b2d2d;
      --card:rgba(0,0,0,.35);
      --text:#f5fbff;
      --muted:rgba(255,255,255,.78);
      --good:#2ecc71; --bad:#ff4d4d;
      --ring:0 0 0 3px rgba(117,214,255,.35);
      --shadow:0 12px 32px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(117,214,255,.22), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(255,204,51,.12), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .topbar{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(90deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(255,255,255,.12);
      padding:.8rem 1rem;
    }
    .brand{
      display:flex; align-items:center; justify-content:center; gap:.6rem;
      font-family:"Mountains of Christmas", system-ui, sans-serif;
      font-weight:700;
      letter-spacing:.5px;
      font-size:clamp(1.1rem, 2.4vw, 1.8rem);
      text-shadow:0 6px 20px rgba(0,0,0,.35);
    }
    .wrap{max-width:980px;margin:0 auto;padding:1.2rem}
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:1.1rem;
      margin:1rem 0;
    }
    .soft{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18));
    }
    h1,h2,h3{
      font-family:"Mountains of Christmas", system-ui, sans-serif;
      margin:.2rem 0 .7rem;
      text-shadow:0 8px 22px rgba(0,0,0,.35);
    }
    h1{font-size:clamp(2rem, 4.2vw, 3rem)}
    h2{font-size:clamp(1.5rem, 3.2vw, 2.1rem)}
    h3{font-size:clamp(1.2rem, 2.6vw, 1.6rem)}
    p{color:var(--muted); line-height:1.45}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:1rem}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    @media(max-width:860px){.col-6{grid-column:span 12}}

    .btn{
      appearance:none;border:0;border-radius:12px;
      padding:.75rem 1rem;color:white;
      background:linear-gradient(180deg, rgba(27,110,243,1), rgba(16,72,171,1));
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      cursor:pointer;font-weight:800;letter-spacing:.2px;
      transition:transform .08s ease, filter .12s ease;
      user-select:none;width:100%;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn:focus{outline:none; box-shadow:var(--shadow), var(--ring)}
    .btn.alt{background:linear-gradient(180deg, rgba(23,162,184,1), rgba(13,117,134,1))}
    .btn.green{background:linear-gradient(180deg, rgba(46,204,113,1), rgba(26,145,78,1))}
    .btn.gold{background:linear-gradient(180deg, rgba(255,204,51,1), rgba(196,143,20,1));color:#13202a}
    .btn.red{background:linear-gradient(180deg, rgba(255,77,77,1), rgba(186,37,37,1))}
    .btn.small{padding:.5rem .7rem;border-radius:10px;width:auto;font-weight:800}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .pillbar{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center;margin:.6rem 0 0}
    .pill{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding:.35rem .6rem;border-radius:999px;
      font-size:.9rem;color:rgba(255,255,255,.85);
      font-weight:750;
    }

    select{
      width:100%;
      padding:.85rem .9rem;border-radius:14px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(0,0,0,.28);color:var(--text);
      font-weight:800;font-size:1rem;outline:none;
      appearance:none;
    }
    select:focus{box-shadow:var(--ring)}

    #screenStart,#screenQuiz,#screenEnd{display:none}
    #screenStart{display:block}

    .row{display:flex;gap:1rem;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .qmeta{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}

    .question{font-size:clamp(1.1rem, 2.2vw, 1.45rem);margin:.2rem 0 .8rem}
    .choices{display:grid;grid-template-columns:1fr;gap:.55rem;margin:.6rem 0 0}
    .choice{
      text-align:left;background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.15);
      border-radius:14px;padding:.75rem .85rem;
      cursor:pointer;font-weight:850;line-height:1.25;
      transition:transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .choice:hover{background:rgba(255,255,255,.14)}
    .choice:active{transform:translateY(1px)}
    .choice.correct{background:rgba(46,204,113,.22);border-color:rgba(46,204,113,.55)}
    .choice.wrong{background:rgba(255,77,77,.18);border-color:rgba(255,77,77,.55)}
    .choice.disabled{opacity:.85;cursor:not-allowed}

    .feedback{
      margin:.85rem 0 0;padding:.75rem;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      display:none;
      font-weight:750;
    }
    .feedback.show{display:block}
    .feedback.good{border-color:rgba(46,204,113,.55);background:rgba(46,204,113,.12)}
    .feedback.bad{border-color:rgba(255,77,77,.55);background:rgba(255,77,77,.10)}

    .scoreboard{display:flex;gap:.7rem;flex-wrap:wrap;justify-content:center;margin:.4rem 0 0}
    .teamCard{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;padding:.7rem .8rem;
      min-width:210px;box-shadow:0 10px 20px rgba(0,0,0,.18);
    }
    .teamName{
      font-weight:900;font-size:1.05rem;letter-spacing:.2px;
      padding:.25rem .4rem;border-radius:10px;display:inline-block;
      cursor:text;background:rgba(0,0,0,.18);
      border:1px dashed rgba(255,255,255,.18);
    }
    .teamName[contenteditable="true"]{outline:none;box-shadow:var(--ring)}
    .teamScore{margin-top:.55rem;font-size:2rem;font-weight:950;letter-spacing:.4px}
    .scoreBtns{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.55rem;justify-content:center}
    .mini{font-size:.92rem;color:rgba(255,255,255,.75);margin-top:.35rem}

    .groupControls{margin-top:1rem;display:grid;grid-template-columns:repeat(12,1fr);gap:.7rem}
    .gc-left{grid-column:span 8}
    .gc-right{grid-column:span 4}
    @media(max-width:860px){.gc-left,.gc-right{grid-column:span 12}}

    .buzzRow{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
    .buzzTag{
      background:rgba(255,204,51,.16);
      border:1px solid rgba(255,204,51,.35);
      padding:.35rem .6rem;border-radius:999px;
      font-weight:900;color:#ffe9a8;
    }

    .bigScore{font-size:clamp(2rem, 4vw, 3rem);font-weight:950;color:#ffe9a8;text-shadow:0 12px 26px rgba(0,0,0,.35)}
    input[type="text"]{
      width:100%;padding:.85rem .9rem;border-radius:14px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(0,0,0,.28);color:var(--text);
      font-weight:800;font-size:1rem;outline:none;
    }
    input[type="text"]:focus{box-shadow:var(--ring)}

    .snowflakes{position:fixed;inset:0;pointer-events:none;z-index:50;opacity:.8}
    .snowflake{
      position:fixed;top:-10%;
      color:white;text-shadow:0 0 10px rgba(255,255,255,.55);
      user-select:none;
      animation-name:snowfall,sway;
      animation-timing-function:linear,ease-in-out;
      animation-iteration-count:infinite,infinite;
      will-change:transform,top;
      opacity:.9;font-size:1.2rem;
    }
    @keyframes snowfall{0%{top:-10%}100%{top:110%}}
    @keyframes sway{0%,100%{transform:translateX(0)}50%{transform:translateX(70px)}}
    .snowflake:nth-child(1){left:2%; animation-duration:12s, 4.2s; animation-delay:0s,0s}
    .snowflake:nth-child(2){left:10%;animation-duration:10s, 3.8s; animation-delay:1s,.4s}
    .snowflake:nth-child(3){left:18%;animation-duration:14s, 4.5s; animation-delay:2s,1.1s}
    .snowflake:nth-child(4){left:28%;animation-duration:11s, 4s;   animation-delay:.5s,.2s}
    .snowflake:nth-child(5){left:36%;animation-duration:13s, 4.7s; animation-delay:1.8s,1.6s}
    .snowflake:nth-child(6){left:46%;animation-duration:9.5s,3.4s; animation-delay:.2s,.7s}
    .snowflake:nth-child(7){left:55%;animation-duration:15s,4.9s;  animation-delay:3s,1.9s}
    .snowflake:nth-child(8){left:64%;animation-duration:10.5s,3.9s;animation-delay:1.1s,.9s}
    .snowflake:nth-child(9){left:74%;animation-duration:12.5s,4.1s;animation-delay:2.4s,1.2s}
    .snowflake:nth-child(10){left:82%;animation-duration:9.8s,3.6s;animation-delay:.7s,.5s}
    .snowflake:nth-child(11){left:90%;animation-duration:14.2s,4.6s;animation-delay:2.8s,1.8s}
    .snowflake:nth-child(12){left:96%;animation-duration:11.6s,4s;animation-delay:1.4s,.8s}
  </style>
</head>

<body>
  <div class="snowflakes" aria-hidden="true">
    <div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div><div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div><div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÜ</div><div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div>
  </div>

  <div class="topbar">
    <div class="brand">üéÑ Christmas Trivia Party Game</div>
  </div>

  <div class="wrap">
    <!-- START -->
    <section id="screenStart" class="card soft">
      <h1>Holiday Trivia</h1>
      <p>
        Solo mode auto-scores (+2 / -1) and posts to your Google Sheet.
        Group mode is host-operated with early buzz potential.
      </p>

      <div class="grid">
        <div class="col-12 card">
          <h2>How many questions?</h2>
          <select id="selQuestionCount">
            <option value="30" selected>30</option>
            <option value="50">50</option>
            <option value="70">70</option>
          </select>
          <div class="pillbar">
            <span class="pill">Random order</span>
            <span class="pill">No audio/images</span>
            <span class="pill">5 choices each</span>
          </div>
        </div>

        <div class="col-6 card">
          <h2>Solo Play</h2>
          <p>Choices show immediately. Auto scoring.</p>
          <button id="btnSolo" class="btn green">Play Solo</button>
        </div>

        <div class="col-6 card">
          <h2>Group Play</h2>
          <p>Question shows first. Teams can buzz early for double eligibility.</p>
          <button id="btnGroup2" class="btn alt">Play Group (2 Teams)</button>
          <button id="btnGroup3" class="btn alt">Play Group (3 Teams)</button>
          <button id="btnGroup4" class="btn alt">Play Group (4 Teams)</button>
          <div class="pillbar">
            <span class="pill">Reveal Choices gate</span>
            <span class="pill">Pass button</span>
            <span class="pill">Tie-break mode</span>
          </div>
        </div>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="screenQuiz" class="card soft">
      <div id="scoreboardWrap" class="card" style="display:none">
        <h3 style="margin-bottom:.2rem">Scoreboard</h3>
        <div class="mini">Click a team name to edit. Scores can go negative.</div>
        <div id="scoreboard" class="scoreboard"></div>
      </div>

      <div class="row">
        <div class="qmeta">
          <span id="pillMode" class="pill">Mode: ?</span>
          <span id="pillProgress" class="pill">Q 1 / ?</span>
          <span id="pillScore" class="pill" style="display:none">Score: 0</span>
        </div>
        <div class="qmeta">
          <button id="btnRestart" class="btn small red">Restart</button>
        </div>
      </div>

      <div class="card" style="margin-top:1rem">
        <div id="questionText" class="question">Question goes here</div>

        <div id="choices" class="choices"></div>

        <div id="feedback" class="feedback"></div>

        <div id="groupControls" class="groupControls" style="display:none">
          <div class="gc-left card">
            <h3 style="margin:.1rem 0 .4rem">Group Controls</h3>

            <div class="buzzRow" style="margin:.45rem 0 .6rem">
              <span style="font-weight:850">Buzz:</span>
              <div id="buzzButtons" class="buzzRow"></div>
              <span id="buzzStatus" class="buzzTag" style="display:none"></span>
              <button id="btnClearBuzz" class="btn small red" style="display:none">Clear Buzz</button>
            </div>

            <div class="buzzRow">
              <button id="btnReveal" class="btn gold">Reveal Choices</button>
              <button id="btnPass" class="btn alt">Pass</button>
              <button id="btnNext" class="btn green" disabled>Next Question</button>
            </div>

            <div class="mini" style="margin-top:.55rem">
              If a team buzzes before reveal, a correct answer can be worth <b>+4</b> (double) instead of +2.
            </div>
          </div>

          <div class="gc-right card">
            <h3 style="margin:.1rem 0 .4rem">Quick Score Hint</h3>
            <div id="scoreHint" class="pill" style="display:none; text-align:left"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- END -->
    <section id="screenEnd" class="card soft">
      <h2 id="endTitle">Finished!</h2>

      <div id="soloEndBlock" style="display:none">
        <div class="bigScore" id="endScore">Score: 0</div>
        <p>Enter your name to save your score to the leaderboard.</p>

        <div class="grid">
          <div class="col-6">
            <input id="nameInput" type="text" maxlength="50" placeholder="Your name" />
          </div>
          <div class="col-6">
            <button id="btnSubmit" class="btn green">Submit Score</button>
          </div>
          <div class="col-12">
            <div id="submitStatus" class="pill" style="display:none"></div>
          </div>
        </div>
      </div>

      <div id="groupEndBlock" style="display:none">
        <div class="bigScore" id="winnerText">Winner goes here</div>
        <div id="finalScores" class="card" style="margin-top:1rem"></div>
      </div>

      <div style="margin-top:1rem">
        <button id="btnPlayAgain" class="btn alt">Back to Start</button>
      </div>
    </section>
  </div>

<script>
/* ============================
   Google Sheets Web App URL (UPDATED)
   ============================ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxW8WjJJ37mjvgwisDeaqo1hPfOzzZLhPbgOugAZFT0E0U0TTpd07QefMDT7lX16mkduA/exec";

/* ============================
   Utilities
   ============================ */
function shuffle(arr){
  for (let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

/* ============================
   Question Model
   ============================ */
function Q(id, prompt, answer, distractors) {
  return { id, prompt, answer, distractors };
}

/* ============================
   Pre-made Questions ONLY (your list)
   - No audio/images
   - Lyric-heavy questions paraphrased to avoid copyrighted text
   ============================ */
const QUESTION_BANK = [
  Q("q001","Which popular Christmas beverage is also called ‚Äúmilk punch‚Äù?", "Eggnog",
    ["Hot chocolate","Mulled wine","Apple cider","North Pole Latte"]),
  Q("q002","What did the other reindeer not let Rudolph do because of his shiny red nose?", "Join in any reindeer games",
    ["Lead Santa‚Äôs sleigh","Wear a bell","Fly on Christmas Eve","Eat the carrots"]),
  Q("q003","How many ghosts show up in A Christmas Carol?", "Four",
    ["Three","Five","Two","A whole ghost parade"]),
  Q("q004","Where was baby Jesus born?", "Bethlehem",
    ["Nazareth","Jerusalem","Rome","Candy Cane City"]),
  Q("q005","Miracle on 34th Street is based on a real-life department store. What is it?", "Macy‚Äôs",
    ["Saks Fifth Avenue","Bloomingdale‚Äôs","Gimbels","Target"]),
  Q("q006","What are two popular names for Santa Claus?", "Kris Kringle and Saint Nick",
    ["Old Man Winter and Jack Frost","Father Christmas and Snow King","Santa and Captain Cheer","Mr. Jolly and The Toy Boss"]),
  Q("q007","Elvis isn‚Äôt going to have a white Christmas, he‚Äôs going to have a‚Ä¶", "Blue Christmas",
    ["Gold Christmas","Snowy Christmas","Jazzy Christmas","Neon Christmas"]),
  Q("q008","What do people traditionally put on top of a Christmas tree?", "An angel",
    ["A star","A bow","A candy cane","A tiny disco ball"]),
  Q("q009","In Home Alone 2: Lost in New York, where are the McCallisters going on vacation when they leave Kevin behind?", "Paris",
    ["London","Rome","New York","The North Pole"]),
  Q("q010","In How the Grinch Stole Christmas, the Grinch was described with three words. What are they?", "Stink, stank, stunk",
    ["Mean, green, unseen","Grump, grinch, grouch","Cold, bold, old","Yikes, bikes, likes"]),
  Q("q011","In which modern-day country was St. Nicholas born?", "Turkey",
    ["Greece","Italy","Germany","The North Pole"]),
  Q("q012","In It‚Äôs a Wonderful Life, what happened every time a bell rang?", "An angel got his wings",
    ["Snow began to fall","Santa laughed","A candle lit itself","A reindeer sneezed"]),
  Q("q013","What words follow ‚ÄúSilent Night‚Äù in the song?", "Holy night",
    ["Snowy night","Bright night","Peaceful night","Jolly night"]),
  Q("q014","Which Hollywood actor played six different roles in The Polar Express?", "Tom Hanks",
    ["Tim Allen","Jim Carrey","Will Ferrell","Danny Elfman"]),
  Q("q015","In A Christmas Carol, what was Scrooge‚Äôs first name?", "Ebenezer",
    ["Edmund","Eugene","Elijah","Eggbert"]),
  Q("q016","Which country did eggnog come from?", "England",
    ["France","Ireland","Germany","Whoville"]),
  Q("q017","Which real-life person is Santa Claus based on?", "The Christian bishop St. Nicholas",
    ["King Arthur","Saint Patrick","Julius Caesar","A famous toy maker"]),
  Q("q018","What did Frosty the Snowman do when a magic hat was placed on his head?", "He began to dance around",
    ["He sang carols","He melted a little","He grew taller","He did the Macarena"]),
  Q("q019","Which branch of the military runs ‚ÄúToys for Tots‚Äù?", "The Marines",
    ["The Army","The Navy","The Air Force","The Reindeer Corps"]),
  Q("q020","Which Christmas song was recorded by Jose Feliciano in 1970?", "Feliz Navidad",
    ["Jingle Bell Rock","White Christmas","Silent Night","Santa Baby"]),
  Q("q021","Approximately 1.3 billion of these are sent each year in the U.S. during Christmas. What are they?", "Christmas cards",
    ["Snowflakes","Candy canes","Gift receipts","Holiday sweaters"]),
  Q("q022","The first artificial Christmas tree was made from what?", "Goose feathers",
    ["Pine needles","Paper","Plastic","Elf hair"]),
  Q("q023","What do children get from Santa if they‚Äôre on the ‚ÄúNaughty List‚Äù?", "A lump of coal",
    ["A candy cane","An empty stocking","A stern letter","A sock full of broccoli"]),
  Q("q024","What is the name of Rudolph‚Äôs girlfriend?", "Clarice",
    ["Vixen","Holly","Noelle","Cinnamon"]),
  Q("q025","In ‚ÄúFrosty the Snowman,‚Äù what made Frosty come to life?", "An old silk hat",
    ["A scarf","A carrot nose","A snowball","A top-secret snow potion"]),
  Q("q026","In A Christmas Story, what is Ralphie‚Äôs little brother‚Äôs name?", "Randy",
    ["Ronnie","Ricky","Raymond","Rudolph"]),
  Q("q027","Which Christmas song includes a lyric about everyone dancing merrily in an old-fashioned way?", "Rocking Around the Christmas Tree",
    ["Jingle Bell Rock","Winter Wonderland","Deck the Halls","Frosty the Snowman"]),
  Q("q028","What are you supposed to do when you find yourself under the mistletoe?", "Kiss",
    ["Sing","Run away","High-five","Do a backflip"]),
  Q("q029","Which one of Santa‚Äôs reindeer has the same name as another holiday mascot?", "Cupid",
    ["Comet","Donner","Dasher","Blitzen"]),
  Q("q030","Which country started the tradition of putting up a Christmas tree?", "Germany",
    ["England","France","Italy","Candyland"]),
  Q("q031","In ‚ÄúWinter Wonderland,‚Äù what do we call the snowman?", "Parson Brown",
    ["Frosty","Jack Frost","Mr. Snow","Captain Chill"]),
  Q("q032","In Elf, what was the first rule of ‚ÄúThe Code of Elves‚Äù?", "Treat every day like Christmas",
    ["Sing loudly","Make toys quickly","Never eat veggies","Always wear green"]),
  Q("q033","What‚Äôs the name of the main villain in The Nightmare Before Christmas?", "Oogie Boogie",
    ["Jack Skellington","Sally","Dr. Finkelstein","Mr. Grumblepants"]),
  Q("q034","In The Twelve Days of Christmas, what did my true love give to me on the eighth day?", "Eight maids a-milking",
    ["Eight swans a-swimming","Eight ladies dancing","Eight pipers piping","Eight cats a-meowing"]),
  Q("q035","What was the highest-grossing Christmas movie of all time (commonly cited)?", "Home Alone",
    ["Elf","The Polar Express","The Grinch","A Christmas Carol"]),
  Q("q036","In ‚ÄúThe Christmas Song,‚Äù whose eyes are said to be all aglow?", "Tiny tots",
    ["Big reindeer","Snowmen","Carolers","Gingerbread people"]),
  Q("q037","What was the real name of the character Tim Allen plays in The Santa Clause?", "Scott Calvin",
    ["Clark Griswold","Buddy Hobbs","Kevin McCallister","Stan Nick"]),
  Q("q038","How many gifts in total were given in ‚ÄúThe Twelve Days of Christmas‚Äù song?", "364",
    ["12","78","120","365"]),
  Q("q039","Which fairy tale inspired the first gingerbread houses?", "Hansel and Gretel",
    ["Cinderella","Rapunzel","Snow White","The Three Little Pigs"]),
  Q("q040","In A Christmas Story, what was the name of the neighbors whose dog ate the Christmas turkey?", "The Bumpuses",
    ["The Griswolds","The McCallisters","The Cratchits","The Barkersons"]),
  Q("q041","How do you say ‚ÄúMerry Christmas‚Äù in Spanish?", "Feliz Navidad",
    ["Buon Natale","Joyeux No√´l","Frohe Weihnachten","Hola Snowman"]),
  Q("q042","What Christmas decoration was originally made from silver?", "Tinsel",
    ["Ornaments","Garland","Ribbons","Sparkly unicorn hair"]),
  Q("q043","Which Christmas ballet premiered in 1892?", "The Nutcracker",
    ["Swan Lake","Sleeping Beauty","Cinderella","The Snow Queen"]),
  Q("q044","Which animated film involves a train that carries kids to the North Pole on Christmas?", "The Polar Express",
    ["Elf","Home Alone","Miracle on 34th Street","The Santa Clause"]),
  Q("q045","In ‚ÄúWe Wish You a Merry Christmas,‚Äù what type of pudding is mentioned?", "Figgy pudding",
    ["Plum pudding","Chocolate pudding","Bread pudding","Pickle pudding"]),
  Q("q046","How many pounds does the average person gain at Christmastime?", "One to two pounds",
    ["Ten pounds","Five pounds","Zero pounds","Twenty-seven pounds"]),
  Q("q047","Which horned figure punishes naughty children at Christmastime?", "Krampus",
    ["Jack Frost","The Grinch","Santa‚Äôs Coach","The Snow Beast"]),
  Q("q048","This hot-spiced cider is a popular Yuletide tradition. What is it?", "Wassail",
    ["Eggnog","Hot chocolate","Mulled wine","Reindeer juice"]),
  Q("q049","What‚Äôs the German name for ‚ÄúO Christmas Tree‚Äù?", "O Tannenbaum",
    ["Stille Nacht","Frohe Weihnachten","O Weihnachtsbaum","O Candybaum"]),
  Q("q050","Who played George Bailey in It‚Äôs a Wonderful Life?", "Jimmy Stewart",
    ["Henry Fonda","Cary Grant","James Dean","Jimmy Neutron"]),
  Q("q051","Where did the word and idea ‚ÄúChristmukkah‚Äù come from?", "The O.C.",
    ["Friends","Seinfeld","The Simpsons","A greeting card company"]),
  Q("q052","What is the name of the last ghost that visits Scrooge?", "The Ghost of Christmas Yet To Come",
    ["The Ghost of Christmas Past","The Ghost of Christmas Present","The Ghost of New Year‚Äôs Day","The Ghost of Leftovers"]),
  Q("q053","Visions of which food danced in children‚Äôs heads in ‚Äú‚ÄòTwas The Night Before Christmas‚Äù?", "Sugar plums",
    ["Candy canes","Cookies","Gingerbread","Spaghetti"]),
  Q("q054","What gift did the Little Drummer Boy give to the newborn Christ?", "He played a song for him on his drums",
    ["Gold coins","A carved toy","A warm blanket","A kazoo solo"]),
  Q("q055","What is often cited as the best-selling Christmas song ever?", "White Christmas by Bing Crosby",
    ["Jingle Bells","Silent Night","Feliz Navidad","All I Want for Christmas Is You"]),
  Q("q056","Who wrote, ‚ÄúChristmas doesn‚Äôt come from a store; maybe Christmas means a little bit more‚Äù?", "Dr. Seuss",
    ["Roald Dahl","Charles Dickens","J.K. Rowling","Professor Snowpants"]),
  Q("q057","Three of Santa‚Äôs reindeer‚Äôs names begin with ‚ÄúD.‚Äù What are they?", "Dancer, Dasher and Donner",
    ["Donner, Cupid and Vixen","Dasher, Blitzen and Comet","Dancer, Prancer and Rudolph","Donut, Doodle and Dave"]),
  Q("q058","What was Frosty the Snowman‚Äôs nose made out of?", "A button",
    ["A carrot","A pebble","A cherry","A tiny marshmallow"]),
  Q("q059","What is George Bailey‚Äôs guardian angel‚Äôs name?", "Clarence Odbody",
    ["Gabriel","Michael","Harold","Clarence the Reindeer"]),
  Q("q060","In the 1964 Rudolph movie, what was Rudolph‚Äôs elf friend‚Äôs name?", "Hermey",
    ["Herman","Harvey","Henry","Hambone"]),
  Q("q061","What popular Christmas song was actually written for Thanksgiving?", "Jingle Bells",
    ["White Christmas","Silent Night","O Holy Night","Frosty the Snowman"]),
  Q("q062","What was the first company that used Santa Claus in advertising?", "Coca-Cola",
    ["Pepsi","Kellogg‚Äôs","Ford","Nintendo"]),
  Q("q063","In ‚ÄúThe Christmas Song,‚Äù who does the narrator see kissing Santa Claus under the mistletoe?", "Mommy",
    ["Daddy","Grandma","The babysitter","A snowman"]),
  Q("q064","In Elf, how does Buddy get to the North Pole?", "He hides in Santa‚Äôs sack",
    ["He rides a reindeer","He takes a train","He teleports","He skis there"]),
  Q("q065","In ‚ÄòTwas the Night Before Christmas, where did there arise such a clatter?", "On the lawn",
    ["In the chimney","In the kitchen","On the roof","In the toy shop"]),
  Q("q066","What are Christmas trees also called?", "Yule-Tree",
    ["Noel-Pine","Holiday Spruce","Winterwood","Jolly Bush"]),
  Q("q067","This holiday treat was designed to resemble a shepherd‚Äôs staff. What is it?", "Candy canes",
    ["Gingerbread men","Sugar cookies","Peppermint bark","Chocolate bells"]),
  Q("q068","In Canada, which holiday is celebrated the day after Christmas?", "Boxing Day",
    ["Maple Day","Winter Day","Gift Day","Snow Day"]),
  Q("q069","In which war did a ‚ÄúChristmas Truce‚Äù take place?", "World War I",
    ["World War II","Civil War","Korean War","The War on Fruitcake"]),
  Q("q070","Who voiced the Grinch in the 1966 television special?", "Boris Karloff",
    ["Jim Carrey","Benedict Cumberbatch","Morgan Freeman","Santa himself"]),
  Q("q071","Which popular phrase was made popular by Scrooge?", "Bah humbug!",
    ["Ho ho ho!","Merry and bright!","Jingle all the way!","Happy snow day!"]),
  Q("q072","How many reindeer appear in ‚Äú‚ÄòTwas the Night Before Christmas‚Äù?", "Eight",
    ["Seven","Nine","Ten","One very confused moose"]),
  Q("q073","Which Christmas treat is known for its long shelf life?", "Fruitcake",
    ["Gingerbread","Candy cane","Yule log cake","Marshmallows"]),
  Q("q074","In North America, what‚Äôs another name for wild reindeer?", "Caribou",
    ["Moose","Elk","Bison","Snow horse"]),
  Q("q075","What is the family name in National Lampoon‚Äôs Christmas Vacation?", "The Griswolds",
    ["The McCallisters","The Bumpuses","The Cratchits","The Who-ville-sons"]),
  Q("q076","What meal do people in Japan traditionally eat on Christmas?", "Kentucky Fried Chicken",
    ["Sushi","Ramen","Tacos","A single rice cracker"]),
  Q("q077","What was Frosty the Snowman‚Äôs pipe made from?", "A corncob",
    ["A candy cane","A carrot","A twig","A tiny trombone"]),
  Q("q078","Which action movie from the 1980s takes place on Christmas Eve?", "Die Hard",
    ["Lethal Weapon","Predator","Rocky IV","Terminator"]),
  Q("q079","What is the name of the Grinch‚Äôs dog?", "Max",
    ["Buddy","Rex","Spike","Pancake"]),
  Q("q080","What did the Wise Men present to baby Jesus?", "Gold, frankincense and myrrh",
    ["Gold, silver and bronze","Candy, toys and cookies","Bread, milk and honey","Socks, soap and sandals"]),

  /* 81‚Äì144 (longer trivia). Two lyric-heavy questions paraphrased. */
  Q("q081","A famous novelty holiday song features three singing rodents asking for Christmas to come quickly. What type of rodent are they?", "Chipmunk",
    ["Mouse","Hamster","Squirrel","Capybara"]),
  Q("q082","Tchaikovsky‚Äôs ballet premiered in 1892, but it became a big Christmas tradition after a famous 1954 production of what annual classic?", "The Nutcracker",
    ["Swan Lake","Sleeping Beauty","Cinderella","The Snowman Shuffle"]),
  Q("q083","In Mariah Carey‚Äôs famous Christmas hit, she says she only wants one thing. What is it?", "You",
    ["Presents","Snow","A pony","A new phone"]),
  Q("q084","A boundary pass between Alaska and British Columbia shares a name with the ‚ÄúChristmas‚Äù Bing Crosby is dreaming of. What is it?", "White Pass",
    ["Blue Pass","Silver Pass","North Pass","Candy Pass"]),
  Q("q085","In Japan since the 1970s, families buy Christmas dinner from what fast-food chain founded by Harland Sanders?", "KFC",
    ["McDonald‚Äôs","Burger King","Wendy‚Äôs","Taco Bell"]),
  Q("q086","Who starred in the 2000 live-action remake of How the Grinch Stole Christmas?", "Jim Carrey",
    ["Will Ferrell","Ben Stiller","Mike Myers","Adam Sandler"]),
  Q("q087","Originally titled ‚ÄúThe One Horse Open Sleigh,‚Äù what was the first song played in space in 1965 by Gemini 6A astronauts?", "Jingle Bells",
    ["Silent Night","Deck the Halls","O Holy Night","Space Carol #9"]),
  Q("q088","In a famous Corona holiday ad, what type of tree is suddenly illuminated at the beach?", "Palm",
    ["Pine","Fir","Spruce","Broccoli"]),
  Q("q089","A boy takes a train to the North Pole in what classic 1985 children‚Äôs book by Chris Van Allsburg?", "The Polar Express",
    ["Where the Wild Things Are","The Snowy Day","The Giving Tree","The Candy Cane Caper"]),
  Q("q090","Jos√© Feliciano‚Äôs enduring holiday track has what two-word title?", "Feliz Navidad",
    ["White Christmas","Silent Night","Jingle Bells","Holiday Fiesta"]),
  Q("q091","In A Christmas Story, the leg lamp box is labeled with what cautionary word that‚Äôs 'not Italian'?", "Fragile",
    ["Danger","Delicate","Handle","Spicy"]),
  Q("q092","A 1965 TV special about a comic strip character features a tiny sad Christmas tree. What special is it?", "A Charlie Brown Christmas",
    ["Charlie Brown‚Äôs Thanksgiving","A Snoopy Christmas","Peanuts Holiday Party","Linus Saves Christmas"]),
  Q("q093","Peter Billingsley (Ralphie) appears uncredited in Santa‚Äôs workshop in what classic 2003 Christmas film?", "Elf",
    ["Home Alone","The Santa Clause","The Polar Express","Scrooged"]),
  Q("q094","They‚Äôve starred in the Radio City Christmas Spectacular since 1932. What dance company is it?", "The Rockettes",
    ["The Jinglettes","The Broadway Bells","The Holiday Kickline","The Tap Titans"]),
  Q("q095","Frank Costanza invents ‚ÄúFestivus for the rest of us‚Äù on what ‚Äò90s sitcom?", "Seinfeld",
    ["Friends","Frasier","The Simpsons","Everybody Loves Raymond"]),
  Q("q096","In The Lion, the Witch, and the Wardrobe, what land is always winter but never Christmas?", "Narnia",
    ["Hogwarts","Middle-earth","Neverland","Whoville"]),
  Q("q097","What Mexican beer brand has run the same holiday commercial (with a lit palm tree) since 1990?", "Corona",
    ["Modelo","Dos Equis","Pacifico","Jarritos"]),
  Q("q098","In ‚ÄúFrosty the Snowman,‚Äù what article of clothing makes Frosty come to life?", "Old silk hat",
    ["Wool scarf","Snow boots","Topcoat","Santa cap"]),
  Q("q099","What cocktail name also matches the cold-weather personification ‚Äúnipping at your nose‚Äù in The Christmas Song?", "Jack Frost",
    ["Snow Queen","Winter Wizard","Frost King","Icy McIceface"]),
  Q("q100","In a parody of ‚ÄúJingle Bells,‚Äù what superhero‚Äôs car ‚Äúlost a wheel‚Äù while the Joker got away?", "Batmobile",
    ["DeLorean","Ecto-1","Herbie","Invisible Boatmobile"]),
  Q("q101","A Christmas song about a poor boy invited by the Magi to visit baby Jesus was first recorded in 1951. What‚Äôs the title?", "The Little Drummer Boy",
    ["Do You Hear What I Hear?","O Holy Night","Silent Night","The Tiny Tambourine Kid"]),
  Q("q102","‚ÄúO Tannenbaum‚Äù originated in what country in 1824?", "Germany",
    ["Austria","Switzerland","England","Candyland"]),
  Q("q103","In 1843, Sir Henry Cole created the first ever what?", "Christmas Card",
    ["Gift tag","Advent calendar","Christmas cracker","Fruitcake recipe"]),
  Q("q104","(No abbreviations!) In a funny Christmas-in-Vegas nativity reenactment, people can still withdraw cash. What machine is that?", "Automated Teller Machine",
    ["Cash register","Slot machine","Vending machine","Magic money tree"]),
  Q("q105","In The Twelve Days of Christmas, how many ‚Äúgeese a-laying‚Äù are given?", "Six",
    ["Five","Seven","Eight","A suspicious number of geese"]),
  Q("q106","What NYC event began in 1924 as a Christmas celebration and retail expansion?", "Macy's Thanksgiving Day Parade",
    ["Times Square Ball Drop","Rose Parade","NYC Marathon","SantaCon"]),
  Q("q107","Edward Hibberd Johnson first decorated a tree with what in 1882?", "Lights",
    ["Candles","Tinsel","Popcorn strings","Glow worms"]),
  Q("q108","December 5 is associated with the ‚ÄúChristmas Devil‚Äù in parts of Europe. Who is it?", "Krampus",
    ["The Grinch","Jack Frost","The Yeti","Santa‚Äôs Manager"]),
  Q("q109","Whamageddon is a challenge to avoid hearing what Wham Christmas song?", "Last Christmas",
    ["Wake Me Up Before You Go-Go","Careless Whisper","Everything She Wants","Jingle Bells"]),
  Q("q110","A classic holiday tune opens with a line about what roasted treat?", "Chestnut",
    ["Marshmallow","Apple","Turkey","Gingerbread"]),
  Q("q111","In A Christmas Story, what chocolaty drink powder is in the decoded message?", "Ovaltine",
    ["Nesquik","Hershey‚Äôs Syrup","Swiss Miss","Choco-Dust 3000"]),
  Q("q112","Which festive hit helped Brenda Lee top the Billboard Hot 100 in 2023?", "Rockin' Around the Christmas Tree",
    ["Jingle Bell Rock","White Christmas","Feliz Navidad","Santa Baby"]),
  Q("q113","A Mr. Bean Christmas bit inspired a Friends gag of what turkey-head-stuck character?", "Joey",
    ["Ross","Chandler","Monica","Gunther"]),
  Q("q114","Tchaikovsky used the celesta in The Nutcracker for the ‚ÄúDance of‚Äù what character?", "The Sugar Plum Fairy",
    ["The Snow King","The Nutcracker Prince","The Mouse Queen","The Peppermint Knight"]),
  Q("q115","Which 90s Christmas classic started as an idea John Hughes had while planning a family vacation?", "Home Alone",
    ["Elf","The Santa Clause","The Grinch","Jingle All the Way"]),
  Q("q116","What band known for strings, pyrotechnics, and Christmas storylines is called an arena-rock juggernaut?", "Trans-Siberian Orchestra",
    ["Imagine Dragons","Metallica","Chicago","The Jingle Belles"]),
  Q("q117","Who played Hans Gruber in Die Hard?", "Alan Rickman",
    ["Bruce Willis","Jeremy Irons","Gary Oldman","Dr. Evil"]),
  Q("q118","In the holiday ‚ÄúLDB Challenge,‚Äù participants try to avoid hearing what seasonal tune?", "The Little Drummer Boy",
    ["Jingle Bells","Silent Night","White Christmas","Feliz Navidad"]),
  Q("q119","Eating KFC on Christmas Day is a tradition since the 1970s in what nation?", "Japan",
    ["Australia","Brazil","Canada","Iceland"]),
  Q("q120","The Blue Room Christmas Tree is the official tree of which residence?", "White House",
    ["Buckingham Palace","The Vatican","10 Downing Street","The North Pole HQ"]),
  Q("q121","Which soda company commissioned A Charlie Brown Christmas as a holiday special?", "Coca-Cola",
    ["Pepsi","Dr Pepper","Sprite","Root Beer Santa Co."]),
  Q("q122","A 2020 holiday episode featuring the Heeler family celebrates an Australian Christmas in what animated series?", "Bluey",
    ["Peppa Pig","Paw Patrol","SpongeBob SquarePants","Santa‚Äôs Science Show"]),
  Q("q123","In The Twelve Days of Christmas, Frederic Austin‚Äôs version ends with 12 of what?", "Drummers Drumming",
    ["Pipers Piping","Lords a-Leaping","Ladies Dancing","Penguins Paddling"]),
  Q("q124","What hit country song includes a story about driving toward Cincinnati on a snowy Christmas Eve?", "Jesus Take the Wheel",
    ["Before He Cheats","Wagon Wheel","Need You Now","Jingle Bell Cowboy"]),
  Q("q125","In what Fox teen drama did Seth Cohen claim to have invented Chrismukkah?", "The O.C.",
    ["Glee","Dawson‚Äôs Creek","The Office","The Santa Diaries"]),
  Q("q126","Dickens drew on memories of a prison visit to create what character in A Christmas Carol?", "Jacob Marley",
    ["Tiny Tim","Bob Cratchit","Fezziwig","Ebenezer Scrooge"]),
  Q("q127","Which fir is a Christmas favorite and has needles rich in vitamin C?", "Balsam",
    ["Douglas","Fraser","Scots Pine","Fizzing Fir of Fun"]),
  Q("q128","How old is Kevin McCallister in Home Alone?", "Eight years old",
    ["Six years old","Ten years old","Twelve years old","Thirty-five years old"]),
  Q("q129","Die Hard takes place on Christmas Eve in which city?", "Los Angeles",
    ["New York","Chicago","San Francisco","Gotham City"]),
  Q("q130","In Harry Potter and the Philosopher‚Äôs Stone, what do the Dursleys give Harry for Christmas?", "A 50-pence piece",
    ["A new broomstick","A sweater","A wand polish kit","A lump of coal"]),
  Q("q131","In what classic novel does the protagonist set sail on a cold Christmas day?", "Moby Dick",
    ["Treasure Island","Robinson Crusoe","The Odyssey","The Polar Express"]),
  Q("q132","Who declares, ‚ÄúMerry Christmas, one and all!‚Äù in A Christmas Carol?", "Tiny Tim",
    ["Scrooge","Bob Cratchit","Jacob Marley","The Grinch"]),
  Q("q133","How many gifts in total were given in The Twelve Days of Christmas?", "364",
    ["12","78","120","365"]),
  Q("q134","What is the name of the main big baddie in The Nightmare Before Christmas?", "Oogie Boogie",
    ["Jack Skellington","Sally","Zero","Mr. Snowdoom"]),
  Q("q135","How many siblings does Kevin have in Home Alone?", "Four",
    ["Three","Five","Two","Forty"]),
  Q("q136","What is the name of Kristoff‚Äôs reindeer in Frozen?", "Sven",
    ["Olaf","Hans","Pabbie","Rudolph"]),
  Q("q137","In Home Alone, what festive song does Kevin mime along to in front of the mirror?", "Rocking Around The Christmas Tree",
    ["Jingle Bell Rock","Silent Night","White Christmas","Feliz Navidad"]),
  Q("q138","What does Harry receive from Dumbledore during his first Christmas at Hogwarts?", "Cloak of Invisibility",
    ["A new broomstick","A chocolate frog","A map","A lump of coal"]),
  Q("q139","What is the name of Anna and Elsa‚Äôs kingdom in Frozen?", "Arendelle",
    ["Westeros","Atlantis","Corona","Candyland"]),
  Q("q140","Which TV family has a pet dog called Santa‚Äôs Little Helper?", "The Simpsons",
    ["Family Guy","The Flintstones","South Park","Bluey"]),
  Q("q141","Which show has an episode where teens steal a Christmas tree, Red works for Bob, and bonds with Kelso over Pong?", "That '70s Show",
    ["Friends","Seinfeld","The Office","How I Met Your Mother"]),
  Q("q142","Which show has a Christmas episode where Becky and Mark are stuck by a snowstorm, and Nana Mary gets decorated?", "Roseanne",
    ["Full House","The Simpsons","Modern Family","The Santa Files"]),
  Q("q143","Which show has a Secret Santa that turns into Yankee Swap, including an iPod and a teapot, and Meredith gets very drunk?", "The Office",
    ["Parks and Recreation","Brooklyn Nine-Nine","Friends","Scrubs"]),
  Q("q144","Which show has a main character who just wanted to be left alone on Christmas to watch ‚ÄúKISS Saves Santa‚Äù?", "Family Guy",
    ["South Park","The Simpsons","Futurama","Seinfeld"])
];

/* ============================
   Game State / UI
   ============================ */
const $ = (sel)=>document.querySelector(sel);

const screenStart = $("#screenStart");
const screenQuiz = $("#screenQuiz");
const screenEnd = $("#screenEnd");

const pillMode = $("#pillMode");
const pillProgress = $("#pillProgress");
const pillScore = $("#pillScore");

const scoreboardWrap = $("#scoreboardWrap");
const scoreboard = $("#scoreboard");

const questionText = $("#questionText");
const choicesEl = $("#choices");
const feedbackEl = $("#feedback");

const groupControls = $("#groupControls");
const btnReveal = $("#btnReveal");
const btnPass = $("#btnPass");
const btnNext = $("#btnNext");
const buzzButtons = $("#buzzButtons");
const buzzStatus = $("#buzzStatus");
const btnClearBuzz = $("#btnClearBuzz");
const scoreHint = $("#scoreHint");

const btnRestart = $("#btnRestart");
const btnPlayAgain = $("#btnPlayAgain");
const endTitle = $("#endTitle");
const soloEndBlock = $("#soloEndBlock");
const groupEndBlock = $("#groupEndBlock");
const endScore = $("#endScore");
const nameInput = $("#nameInput");
const btnSubmit = $("#btnSubmit");
const submitStatus = $("#submitStatus");
const winnerText = $("#winnerText");
const finalScores = $("#finalScores");
const selQuestionCount = $("#selQuestionCount");

$("#btnSolo").addEventListener("click", ()=>startGame("solo", 1));
$("#btnGroup2").addEventListener("click", ()=>startGame("group", 2));
$("#btnGroup3").addEventListener("click", ()=>startGame("group", 3));
$("#btnGroup4").addEventListener("click", ()=>startGame("group", 4));
btnPlayAgain.addEventListener("click", ()=>goToStart());
btnRestart.addEventListener("click", ()=>goToStart());

let mode = "solo";
let teamCount = 0;
let teamScores = [];
let teamNames = [];
let soloScore = 0;

let gameQuestions = [];
let qIndex = 0;
let targetCount = 30;
let isTieBreaker = false;

let choicesRevealed = false;
let buzzedTeam = null;
let buzzWasBeforeReveal = false;

let answeredLocked = false;

function goToStart(){
  screenQuiz.style.display = "none";
  screenEnd.style.display = "none";
  screenStart.style.display = "block";
  resetState();
}
function resetState(){
  mode="solo"; teamCount=0;
  teamScores=[]; teamNames=[];
  soloScore=0;
  gameQuestions=[]; qIndex=0; isTieBreaker=false;
  choicesRevealed=false; buzzedTeam=null; buzzWasBeforeReveal=false;
  answeredLocked=false;

  feedbackEl.className="feedback";
  feedbackEl.textContent="";
  feedbackEl.style.display="none";
  scoreHint.style.display="none";
  scoreHint.textContent="";
  submitStatus.style.display="none";
  nameInput.value="";
}

function buildQuizQuestions(n){
  // Avoid duplicate prompts in a single game (your list includes a few duplicates).
  const pool = [...QUESTION_BANK];
  shuffle(pool);

  const chosen = [];
  const usedPrompts = new Set();

  for (const q of pool){
    if (chosen.length >= n) break;
    const key = q.prompt.trim().toLowerCase();
    if (usedPrompts.has(key)) continue;
    usedPrompts.add(key);
    chosen.push(q);
  }

  // If we still don't have enough (shouldn't happen), allow duplicates.
  if (chosen.length < n){
    const remaining = pool.filter(q => !chosen.includes(q));
    shuffle(remaining);
    while (chosen.length < n && remaining.length) chosen.push(remaining.pop());
  }

  // buffer for tie-breakers
  const buffer = pool.filter(q => !chosen.includes(q));
  shuffle(buffer);
  return chosen.concat(buffer.slice(0, 40));
}

function startGame(newMode, teams){
  resetState();
  mode=newMode;
  teamCount=teams;
  targetCount = parseInt(selQuestionCount.value, 10);

  gameQuestions = buildQuizQuestions(targetCount);
  qIndex = 0;

  screenStart.style.display="none";
  screenEnd.style.display="none";
  screenQuiz.style.display="block";

  pillMode.textContent = `Mode: ${mode==="solo" ? "Solo" : `Group (${teamCount} Teams)`}`;
  pillScore.style.display = (mode==="solo") ? "inline-flex" : "none";
  pillScore.textContent = "Score: 0";

  groupControls.style.display = (mode==="group") ? "grid" : "none";
  scoreboardWrap.style.display = (mode==="group") ? "block" : "none";

  if (mode==="group"){
    teamScores = Array(teamCount).fill(0);
    teamNames = Array.from({length:teamCount}, (_,i)=>`Team ${i+1}`);
    renderScoreboard();
    buildBuzzButtons();
  }

  renderQuestion();
}

function renderScoreboard(){
  scoreboard.innerHTML="";
  for (let i=0;i<teamCount;i++){
    const card=document.createElement("div");
    card.className="teamCard";

    const name=document.createElement("div");
    name.className="teamName";
    name.textContent=teamNames[i];
    name.setAttribute("contenteditable","false");
    name.addEventListener("click", ()=>{name.setAttribute("contenteditable","true"); name.focus();});
    name.addEventListener("blur", ()=>{
      name.setAttribute("contenteditable","false");
      const txt = (name.textContent||"").trim() || `Team ${i+1}`;
      teamNames[i]=txt;
      name.textContent=txt;
      buildBuzzButtons();
    });

    const score=document.createElement("div");
    score.className="teamScore";
    score.id=`teamScore_${i}`;
    score.textContent=String(teamScores[i]);

    const btns=document.createElement("div");
    btns.className="scoreBtns";

    const mk=(label,delta,cls)=> {
      const b=document.createElement("button");
      b.className=cls || "btn small";
      b.textContent=label;
      b.addEventListener("click", ()=>adjustTeamScore(i,delta));
      return b;
    };

    btns.appendChild(mk("+4", +4, "btn small gold"));
    btns.appendChild(mk("+2", +2, "btn small green"));
    btns.appendChild(mk("+1", +1, "btn small"));
    btns.appendChild(mk("-1", -1, "btn small red"));
    btns.appendChild(mk("-2", -2, "btn small red"));

    const mini=document.createElement("div");
    mini.className="mini";
    mini.textContent="Edit name ‚Ä¢ Adjust score";

    card.appendChild(name);
    card.appendChild(score);
    card.appendChild(btns);
    card.appendChild(mini);
    scoreboard.appendChild(card);
  }
}
function adjustTeamScore(teamIdx,delta){
  teamScores[teamIdx]+=delta; // allow negative
  const el=document.getElementById(`teamScore_${teamIdx}`);
  if (el) el.textContent=String(teamScores[teamIdx]);
}

function buildBuzzButtons(){
  buzzButtons.innerHTML="";
  for (let i=0;i<teamCount;i++){
    const b=document.createElement("button");
    b.className="btn small";
    b.textContent=`Buzz: ${teamNames[i]}`;
    b.addEventListener("click", ()=>{
      if (answeredLocked) return;
      buzzedTeam=i;
      buzzWasBeforeReveal=!choicesRevealed;
      buzzStatus.style.display="inline-flex";
      buzzStatus.textContent = `${teamNames[i]} buzzed ${buzzWasBeforeReveal ? "(early = double eligible)" : ""}`;
      btnClearBuzz.style.display="inline-flex";
      scoreHint.style.display="none";
    });
    buzzButtons.appendChild(b);
  }
  btnClearBuzz.style.display = (buzzedTeam!==null) ? "inline-flex" : "none";
  btnClearBuzz.onclick=()=>{
    buzzedTeam=null; buzzWasBeforeReveal=false;
    buzzStatus.style.display="none";
    btnClearBuzz.style.display="none";
  };
}

btnReveal.addEventListener("click", ()=>{
  if (answeredLocked) return;
  choicesRevealed = !choicesRevealed;
  if (choicesRevealed){
    btnReveal.textContent="Hide Choices";
    choicesEl.style.display="grid";
  } else {
    btnReveal.textContent="Reveal Choices";
    choicesEl.style.display="none";
  }
});

btnPass.addEventListener("click", ()=>{
  if (answeredLocked) return;
  showFeedback("Pass. Nobody answered. Moving on.", "bad");
  btnNext.disabled=false;
});

btnNext.addEventListener("click", ()=>nextQuestion());

function renderQuestion(){
  answeredLocked=false;
  btnNext.disabled=true;
  scoreHint.style.display="none";
  scoreHint.textContent="";

  feedbackEl.className="feedback";
  feedbackEl.textContent="";
  feedbackEl.style.display="none";

  const mainTotal=targetCount;
  pillProgress.textContent = `Q ${Math.min(qIndex+1,mainTotal)} / ${mainTotal}` + (isTieBreaker ? " (Tie-breaker)" : "");
  pillScore.textContent = `Score: ${soloScore}`;

  const q=gameQuestions[qIndex];
  questionText.textContent = q.prompt;

  const options = buildFiveChoices(q);
  renderChoices(options, q.answer);

  if (mode==="solo"){
    choicesEl.style.display="grid";
  } else {
    choicesRevealed=false;
    btnReveal.textContent="Reveal Choices";
    choicesEl.style.display="none";

    buzzedTeam=null;
    buzzWasBeforeReveal=false;
    buzzStatus.style.display="none";
    btnClearBuzz.style.display="none";
  }
}

function buildFiveChoices(q){
  const set=new Set([q.answer]);
  const d=[...q.distractors];
  shuffle(d);
  for (const x of d){
    if (set.size>=5) break;
    set.add(x);
  }
  // sanity fallback (shouldn‚Äôt be needed)
  while (set.size<5){
    set.add("Holiday Surprise " + Math.floor(Math.random()*1000));
  }
  const arr=Array.from(set);
  shuffle(arr);
  return arr.slice(0,5);
}

function renderChoices(options, correct){
  choicesEl.innerHTML="";
  for (const opt of options){
    const div=document.createElement("div");
    div.className="choice";
    div.textContent=opt;
    div.addEventListener("click", ()=>onChoose(opt, correct, div));
    choicesEl.appendChild(div);
  }
}

function onChoose(selected, correct, el){
  if (answeredLocked) return;

  if (mode==="group" && !choicesRevealed){
    showFeedback("Reveal choices first (so you can verify the spoken answer).", "bad");
    return;
  }

  answeredLocked=true;
  [...choicesEl.children].forEach(c=>{
    c.classList.add("disabled");
    c.style.pointerEvents="none";
  });

  const isCorrect = (selected===correct);

  [...choicesEl.children].forEach(c=>{
    if (c.textContent===correct) c.classList.add("correct");
  });
  if (!isCorrect) el.classList.add("wrong");

  if (mode==="solo"){
    soloScore += isCorrect ? 2 : -1;
    pillScore.textContent=`Score: ${soloScore}`;

    showFeedback(
      isCorrect ? "‚úÖ Correct! +2" : `‚ùå Incorrect. Correct answer: "${correct}" (-1)`,
      isCorrect ? "good" : "bad"
    );

    setTimeout(()=>nextQuestion(), 3200);
  } else {
    const suggested = isCorrect
      ? ((buzzedTeam!==null && buzzWasBeforeReveal) ? 4 : 2)
      : -1;

    const buzzTxt = (buzzedTeam!==null) ? `Buzzed team: ${teamNames[buzzedTeam]}.` : "No team buzzed.";
    const sugTxt = `Suggested score: ${suggested>=0?"+":""}${suggested}${(suggested===4?" (double)":"")}.`;

    showFeedback(
      (isCorrect ? "‚úÖ Correct." : `‚ùå Incorrect. Correct answer: "${correct}".`) + " " + buzzTxt + " " + sugTxt + " Click Next.",
      isCorrect ? "good" : "bad"
    );

    scoreHint.style.display="block";
    scoreHint.textContent=sugTxt;
    btnNext.disabled=false;
  }
}

function showFeedback(text,kind){
  feedbackEl.textContent=text;
  feedbackEl.className="feedback show " + (kind==="good" ? "good" : "bad");
  feedbackEl.style.display="block";
}

function nextQuestion(){
  qIndex++;

  if (!isTieBreaker && qIndex>=targetCount){
    if (mode==="solo") return endSolo();
    const {max,winners}=getLeaders();
    if (winners.length===1) return endGroup();
    isTieBreaker=true;
    showFeedback(`Tie at ${max} points between: ${winners.map(i=>teamNames[i]).join(", ")}. Sudden death begins.`, "bad");
  }

  if (isTieBreaker && mode==="group"){
    const {winners}=getLeaders();
    if (winners.length===1) return endGroup();
  }

  if (qIndex>=gameQuestions.length){
    // add buffer if ever needed
    const more = buildQuizQuestions(30).slice(0,30);
    gameQuestions = gameQuestions.concat(more);
  }

  renderQuestion();
}

function getLeaders(){
  const max=Math.max(...teamScores);
  const winners=[];
  teamScores.forEach((s,i)=>{if (s===max) winners.push(i);});
  return {max,winners};
}

function endSolo(){
  screenQuiz.style.display="none";
  screenEnd.style.display="block";

  endTitle.textContent="Solo Game Complete!";
  soloEndBlock.style.display="block";
  groupEndBlock.style.display="none";
  endScore.textContent=`Score: ${soloScore}`;
  submitStatus.style.display="none";
}

function endGroup(){
  screenQuiz.style.display="none";
  screenEnd.style.display="block";

  endTitle.textContent="Group Game Complete!";
  soloEndBlock.style.display="none";
  groupEndBlock.style.display="block";

  const {max,winners}=getLeaders();
  winnerText.textContent = winners.length===1
    ? `üèÜ ${teamNames[winners[0]]} won with ${max} points!`
    : `ü§ù Tie at ${max}: ${winners.map(i=>teamNames[i]).join(", ")}`;

  finalScores.innerHTML =
    `<h3 style="margin:.2rem 0 .6rem">Final Scores</h3>` +
    `<div class="pillbar" style="justify-content:flex-start">` +
    teamScores.map((s,i)=>`<span class="pill"><b>${escapeHtml(teamNames[i])}</b>: ${s}</span>`).join("") +
    `</div>`;
}

/* Solo score submit (Name / Time / Score) */
btnSubmit.addEventListener("click", async ()=>{
  const name=(nameInput.value||"").trim();
  if (!name){
    submitStatus.style.display="inline-flex";
    submitStatus.textContent="Please enter your name.";
    return;
  }
  const timeISO=new Date().toISOString();
  submitStatus.style.display="inline-flex";
  submitStatus.textContent="Submitting score...";

  // This assumes your Apps Script is set to accept Name/Time/Score and append to the sheet.
  const url = `${SCRIPT_URL}?Name=${encodeURIComponent(name)}&Time=${encodeURIComponent(timeISO)}&Score=${encodeURIComponent(String(soloScore))}`;

  try{
    await fetch(url, {method:"GET", mode:"no-cors"});
    submitStatus.textContent="Submitted! üéâ (If it doesn‚Äôt show instantly, refresh the sheet.)";
  }catch(e){
    submitStatus.textContent="Submission failed. Check Apps Script deployment settings.";
  }
});

goToStart();
</script>
</body>
</html>


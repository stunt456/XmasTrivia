<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéÑ Christmas Trivia Party Game</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#04162a; --bg2:#0b2d2d;
      --card:rgba(0,0,0,.35);
      --text:#f5fbff;
      --muted:rgba(255,255,255,.78);
      --good:#2ecc71; --bad:#ff4d4d;
      --ring:0 0 0 3px rgba(117,214,255,.35);
      --shadow:0 12px 32px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(117,214,255,.22), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(255,204,51,.12), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .topbar{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(90deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(255,255,255,.12);
      padding:.8rem 1rem;
    }
    .brand{
      display:flex; align-items:center; justify-content:center; gap:.6rem;
      font-family:"Mountains of Christmas", system-ui, sans-serif;
      font-weight:700;
      letter-spacing:.5px;
      font-size:clamp(1.1rem, 2.4vw, 1.8rem);
      text-shadow:0 6px 20px rgba(0,0,0,.35);
    }
    .wrap{max-width:980px;margin:0 auto;padding:1.2rem}
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:1.1rem;
      margin:1rem 0;
    }
    .soft{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18));
    }
    h1,h2,h3{
      font-family:"Mountains of Christmas", system-ui, sans-serif;
      margin:.2rem 0 .7rem;
      text-shadow:0 8px 22px rgba(0,0,0,.35);
    }
    h1{font-size:clamp(2rem, 4.2vw, 3rem)}
    h2{font-size:clamp(1.5rem, 3.2vw, 2.1rem)}
    h3{font-size:clamp(1.2rem, 2.6vw, 1.6rem)}
    p{color:var(--muted); line-height:1.45}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:1rem}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    @media(max-width:860px){.col-6{grid-column:span 12}}

    .btn{
      appearance:none;border:0;border-radius:12px;
      padding:.75rem 1rem;color:white;
      background:linear-gradient(180deg, rgba(27,110,243,1), rgba(16,72,171,1));
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      cursor:pointer;font-weight:800;letter-spacing:.2px;
      transition:transform .08s ease, filter .12s ease;
      user-select:none;width:100%;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn:focus{outline:none; box-shadow:var(--shadow), var(--ring)}
    .btn.alt{background:linear-gradient(180deg, rgba(23,162,184,1), rgba(13,117,134,1))}
    .btn.green{background:linear-gradient(180deg, rgba(46,204,113,1), rgba(26,145,78,1))}
    .btn.gold{background:linear-gradient(180deg, rgba(255,204,51,1), rgba(196,143,20,1));color:#13202a}
    .btn.red{background:linear-gradient(180deg, rgba(255,77,77,1), rgba(186,37,37,1))}
    .btn.small{padding:.5rem .7rem;border-radius:10px;width:auto;font-weight:800}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .pillbar{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center;margin:.6rem 0 0}
    .pill{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding:.35rem .6rem;border-radius:999px;
      font-size:.9rem;color:rgba(255,255,255,.85);
      font-weight:750;
    }

    #screenStart,#screenQuiz,#screenEnd{display:none}
    #screenStart{display:block}

    .row{display:flex;gap:1rem;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .qmeta{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}

    .question{font-size:clamp(1.1rem, 2.2vw, 1.45rem);margin:.2rem 0 .8rem}
    .media{margin:.7rem 0 1rem;display:flex;justify-content:center;align-items:center}
    .media img{max-width:100%;max-height:320px;border-radius:14px;border:1px solid rgba(255,255,255,.16);box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .media audio{width:min(520px, 100%);border-radius:12px}

    .choices{display:grid;grid-template-columns:1fr;gap:.55rem;margin:.6rem 0 0}
    .choice{
      text-align:left;background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.15);
      border-radius:14px;padding:.75rem .85rem;
      cursor:pointer;font-weight:850;line-height:1.25;
      transition:transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .choice:hover{background:rgba(255,255,255,.14)}
    .choice:active{transform:translateY(1px)}
    .choice.correct{background:rgba(46,204,113,.22);border-color:rgba(46,204,113,.55)}
    .choice.wrong{background:rgba(255,77,77,.18);border-color:rgba(255,77,77,.55)}
    .choice.disabled{opacity:.85;cursor:not-allowed}

    .feedback{
      margin:.85rem 0 0;padding:.75rem;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      display:none;
      font-weight:750;
    }
    .feedback.show{display:block}
    .feedback.good{border-color:rgba(46,204,113,.55);background:rgba(46,204,113,.12)}
    .feedback.bad{border-color:rgba(255,77,77,.55);background:rgba(255,77,77,.10)}

    .scoreboard{display:flex;gap:.7rem;flex-wrap:wrap;justify-content:center;margin:.4rem 0 0}
    .teamCard{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;padding:.7rem .8rem;
      min-width:210px;box-shadow:0 10px 20px rgba(0,0,0,.18);
    }
    .teamName{
      font-weight:900;font-size:1.05rem;letter-spacing:.2px;
      padding:.25rem .4rem;border-radius:10px;display:inline-block;
      cursor:text;background:rgba(0,0,0,.18);
      border:1px dashed rgba(255,255,255,.18);
    }
    .teamName[contenteditable="true"]{outline:none;box-shadow:var(--ring)}
    .teamScore{margin-top:.55rem;font-size:2rem;font-weight:950;letter-spacing:.4px}
    .scoreBtns{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.55rem;justify-content:center}
    .mini{font-size:.92rem;color:rgba(255,255,255,.75);margin-top:.35rem}

    .groupControls{margin-top:1rem;display:grid;grid-template-columns:repeat(12,1fr);gap:.7rem}
    .gc-left{grid-column:span 8}
    .gc-right{grid-column:span 4}
    @media(max-width:860px){.gc-left,.gc-right{grid-column:span 12}}

    .buzzRow{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
    .buzzTag{
      background:rgba(255,204,51,.16);
      border:1px solid rgba(255,204,51,.35);
      padding:.35rem .6rem;border-radius:999px;
      font-weight:900;color:#ffe9a8;
    }

    .bigScore{font-size:clamp(2rem, 4vw, 3rem);font-weight:950;color:#ffe9a8;text-shadow:0 12px 26px rgba(0,0,0,.35)}
    input[type="text"]{
      width:100%;padding:.85rem .9rem;border-radius:14px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(0,0,0,.28);color:var(--text);
      font-weight:800;font-size:1rem;outline:none;
    }
    input[type="text"]:focus{box-shadow:var(--ring)}

    .snowflakes{position:fixed;inset:0;pointer-events:none;z-index:50;opacity:.8}
    .snowflake{
      position:fixed;top:-10%;
      color:white;text-shadow:0 0 10px rgba(255,255,255,.55);
      user-select:none;
      animation-name:snowfall,sway;
      animation-timing-function:linear,ease-in-out;
      animation-iteration-count:infinite,infinite;
      will-change:transform,top;
      opacity:.9;font-size:1.2rem;
    }
    @keyframes snowfall{0%{top:-10%}100%{top:110%}}
    @keyframes sway{0%,100%{transform:translateX(0)}50%{transform:translateX(70px)}}
    .snowflake:nth-child(1){left:2%; animation-duration:12s, 4.2s; animation-delay:0s,0s}
    .snowflake:nth-child(2){left:10%;animation-duration:10s, 3.8s; animation-delay:1s,.4s}
    .snowflake:nth-child(3){left:18%;animation-duration:14s, 4.5s; animation-delay:2s,1.1s}
    .snowflake:nth-child(4){left:28%;animation-duration:11s, 4s;   animation-delay:.5s,.2s}
    .snowflake:nth-child(5){left:36%;animation-duration:13s, 4.7s; animation-delay:1.8s,1.6s}
    .snowflake:nth-child(6){left:46%;animation-duration:9.5s,3.4s; animation-delay:.2s,.7s}
    .snowflake:nth-child(7){left:55%;animation-duration:15s,4.9s;  animation-delay:3s,1.9s}
    .snowflake:nth-child(8){left:64%;animation-duration:10.5s,3.9s;animation-delay:1.1s,.9s}
    .snowflake:nth-child(9){left:74%;animation-duration:12.5s,4.1s;animation-delay:2.4s,1.2s}
    .snowflake:nth-child(10){left:82%;animation-duration:9.8s,3.6s;animation-delay:.7s,.5s}
    .snowflake:nth-child(11){left:90%;animation-duration:14.2s,4.6s;animation-delay:2.8s,1.8s}
    .snowflake:nth-child(12){left:96%;animation-duration:11.6s,4s;animation-delay:1.4s,.8s}
  </style>
</head>

<body>
  <div class="snowflakes" aria-hidden="true">
    <div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div><div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div><div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÜ</div><div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div>
  </div>

  <div class="topbar">
    <div class="brand">üéÑ Christmas Trivia Party Game</div>
  </div>

  <div class="wrap">
    <!-- START -->
    <section id="screenStart" class="card soft">
      <h1>Holiday Trivia</h1>
      <p>
        Solo mode auto-scores (+2 / -1) and posts to your Google Sheet.
        Group mode is host-operated with early buzz potential.
      </p>

      <div class="grid">
        <div class="col-6 card">
          <h2>Solo Play</h2>
          <p>Choices show immediately. 30 random questions.</p>
          <button id="btnSolo" class="btn green">Play Solo</button>
        </div>

        <div class="col-6 card">
          <h2>Group Play</h2>
          <p>Question shows first. Teams can buzz early for double eligibility.</p>
          <button id="btnGroup2" class="btn alt">Play Group (2 Teams)</button>
          <button id="btnGroup3" class="btn alt">Play Group (3 Teams)</button>
          <button id="btnGroup4" class="btn alt">Play Group (4 Teams)</button>

          <div class="pillbar">
            <span class="pill">No ‚ÄúWhich of these‚Ä¶‚Äù prompts</span>
            <span class="pill">Early buzz friendly</span>
            <span class="pill">Manual scoring</span>
          </div>
        </div>

        <div class="col-12 card">
          <h3>Optional media folders</h3>
          <p style="margin:0">
            Put files in <b>/audio</b> and <b>/images</b> in your repo.
            Questions reference placeholders like <code>audio/jingle_bells.mp3</code> and <code>images/home_alone.jpg</code>.
          </p>
        </div>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="screenQuiz" class="card soft">
      <div id="scoreboardWrap" class="card" style="display:none">
        <h3 style="margin-bottom:.2rem">Scoreboard</h3>
        <div class="mini">Click a team name to edit. Scores can go negative.</div>
        <div id="scoreboard" class="scoreboard"></div>
      </div>

      <div class="row">
        <div class="qmeta">
          <span id="pillMode" class="pill">Mode: ?</span>
          <span id="pillProgress" class="pill">Q 1 / 30</span>
          <span id="pillScore" class="pill" style="display:none">Score: 0</span>
          <span id="pillCategory" class="pill">Category: üéÅ</span>
        </div>
        <div class="qmeta">
          <button id="btnRestart" class="btn small red">Restart</button>
        </div>
      </div>

      <div class="card" style="margin-top:1rem">
        <div id="questionText" class="question">Question goes here</div>
        <div id="media" class="media"></div>

        <div id="choices" class="choices"></div>

        <div id="feedback" class="feedback"></div>

        <div id="groupControls" class="groupControls" style="display:none">
          <div class="gc-left card">
            <h3 style="margin:.1rem 0 .4rem">Group Controls</h3>

            <div class="buzzRow" style="margin:.45rem 0 .6rem">
              <span style="font-weight:850">Buzz:</span>
              <div id="buzzButtons" class="buzzRow"></div>
              <span id="buzzStatus" class="buzzTag" style="display:none"></span>
              <button id="btnClearBuzz" class="btn small red" style="display:none">Clear Buzz</button>
            </div>

            <div class="buzzRow">
              <button id="btnReveal" class="btn gold">Reveal Choices</button>
              <button id="btnPass" class="btn alt">Pass</button>
              <button id="btnNext" class="btn green" disabled>Next Question</button>
            </div>

            <div class="mini" style="margin-top:.55rem">
              If a team buzzes before reveal, a correct answer can be worth <b>+4</b> (double) instead of +2.
            </div>
          </div>

          <div class="gc-right card">
            <h3 style="margin:.1rem 0 .4rem">Quick Score Hint</h3>
            <div id="scoreHint" class="pill" style="display:none; text-align:left"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- END -->
    <section id="screenEnd" class="card soft">
      <h2 id="endTitle">Finished!</h2>

      <div id="soloEndBlock" style="display:none">
        <div class="bigScore" id="endScore">Score: 0</div>
        <p>Enter your name to save your score to the leaderboard.</p>

        <div class="grid">
          <div class="col-6">
            <input id="nameInput" type="text" maxlength="50" placeholder="Your name" />
          </div>
          <div class="col-6">
            <button id="btnSubmit" class="btn green">Submit Score</button>
          </div>
          <div class="col-12">
            <div id="submitStatus" class="pill" style="display:none"></div>
          </div>
        </div>
      </div>

      <div id="groupEndBlock" style="display:none">
        <div class="bigScore" id="winnerText">Winner goes here</div>
        <div id="finalScores" class="card" style="margin-top:1rem"></div>
      </div>

      <div style="margin-top:1rem">
        <button id="btnPlayAgain" class="btn alt">Back to Start</button>
      </div>
    </section>
  </div>

<script>
/* ============================
   Google Sheets Web App URL
   ============================ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby7ZsgfPb-dw1oxroQT5e3WyhDFspOP3yalxywQReOviGqGpx_slZ07LmnnRgnUJ-ikxw/exec";

/* ============================
   Utilities
   ============================ */
const STOP_WORDS = new Set([
  "the","a","an","and","of","to","in","for","is","it","on","at","with","by",
  "christmas","holiday","holidays","xmas","movie","film","song"
]);

function tokenize(s){
  return String(s)
    .toLowerCase()
    .replace(/[^a-z0-9\s']/g," ")
    .split(/\s+/)
    .filter(Boolean)
    .filter(w => !STOP_WORDS.has(w));
}

function promptContainsAnswerWords(prompt, answer){
  const pset = new Set(tokenize(prompt));
  const a = tokenize(answer);
  return a.some(w => pset.has(w));
}

function shuffle(arr){
  for (let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function pick4Distinct(list){
  const arr = [...new Set(list)];
  shuffle(arr);
  return arr.slice(0,4);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

function stopAnyAudio(){
  document.querySelectorAll("audio").forEach(a=>{ try{ a.pause(); a.currentTime=0; }catch(_){} });
}

/* ============================
   Question Model
   ============================ */
function Q(id, prompt, answer, distractors, meta={}) {
  return {
    id,
    prompt,
    answer,
    distractors,
    category: meta.category || "General",
    type: meta.type || "text", // text | image | audio
    mediaSrc: meta.mediaSrc || null,
    template: meta.template || "misc",
    avoidAnswerWords: meta.avoidAnswerWords ?? false
  };
}

/* ============================
   Movie Titles + SAFE descriptions (avoid title keywords)
   ============================ */
const MOVIE_TITLES = [
  {id:"mv_ha", title:"Home Alone", clue:"A kid is accidentally left behind and defends his house from two burglars using clever traps."},
  {id:"mv_elf", title:"Elf", clue:"A grown man raised at the North Pole travels to New York City to find his real father."},
  {id:"mv_polar", title:"The Polar Express", clue:"A boy takes a magical train ride to the North Pole on Christmas Eve."},
  {id:"mv_grinch", title:"How the Grinch Stole Christmas", clue:"A cranky green creature tries to ruin the holiday for a cheerful town."},
  {id:"mv_story", title:"A Christmas Story", clue:"A boy desperately wants a BB gun, but adults keep warning him he‚Äôll shoot his eye out."},
  {id:"mv_34", title:"Miracle on 34th Street", clue:"A man claims he is the famous gift-giver, and a court case tests whether he‚Äôs telling the truth."},
  {id:"mv_clause", title:"The Santa Clause", clue:"A man accidentally becomes the new holiday gift-giver after a surprising night on his roof."},
  {id:"mv_vac", title:"National Lampoon's Christmas Vacation", clue:"A family‚Äôs holiday plans go hilariously wrong, including an over-the-top light display."},
  {id:"mv_wonder", title:"It's a Wonderful Life", clue:"A man sees what the world would be like if he had never been born."},
  {id:"mv_rud", title:"Rudolph the Red-Nosed Reindeer", clue:"A reindeer with a glowing nose finds his place and helps guide a sleigh through a storm."},
  {id:"mv_frosty", title:"Frosty the Snowman", clue:"A snowman comes to life thanks to a magical hat."},
  {id:"mv_cb", title:"A Charlie Brown Christmas", clue:"A boy feels down about the season and learns what it‚Äôs really about while directing a play."},
  {id:"mv_arth", title:"Arthur Christmas", clue:"An animated adventure where a delivery team races to bring one last missed present."},
  {id:"mv_klaus", title:"Klaus", clue:"A selfish postman teams up with a mysterious toymaker and changes a town forever."},
  {id:"mv_muppet", title:"The Muppet Christmas Carol", clue:"A grouchy businessman is visited by spirits who show him his past, present, and future."},
  {id:"mv_nightmare", title:"The Nightmare Before Christmas", clue:"A Halloween town leader discovers another holiday world and tries to take it over."},
  {id:"mv_jingle", title:"Jingle All the Way", clue:"A dad desperately hunts for a sold-out action figure on the day before Christmas."},
  {id:"mv_scrooged", title:"Scrooged", clue:"A rude TV executive is visited by spirits who force him to rethink his life."},
  {id:"mv_white", title:"White Christmas", clue:"Singers put on a show to help their former commander and a struggling inn."},
  {id:"mv_prancer", title:"Prancer", clue:"A girl believes she has found one of the famous reindeer and tries to protect him."},
  {id:"mv_kranks", title:"Christmas with the Kranks", clue:"A couple tries to skip the holiday, but their neighborhood won‚Äôt allow it."},
  {id:"mv_deck", title:"Deck the Halls", clue:"Two neighbors compete in an escalating battle of decorations."},
  {id:"mv_four", title:"Four Christmases", clue:"A couple ends up visiting four different family gatherings in one day."},
  {id:"mv_chron", title:"The Christmas Chronicles", clue:"Kids accidentally mess up the big delivery night and help save Christmas."}
];

/* ============================
   Premade-style questions (NO lyrics)
   - Includes your examples (minus lyric-quoting ones)
   - Plus many more in the same style
   ============================ */
const PREMADE = [
  Q("pm_001", "Which popular Christmas beverage is also called ‚Äúmilk punch‚Äù?", "Eggnog",
    ["Hot chocolate","Apple cider","Lemonade","Fruit punch"], {category:"Food & Treats", template:"premade"}),

  Q("pm_002", "What did the other reindeer not let Rudolph do because of his shiny red nose?", "Join in any reindeer games",
    ["Lead Santa‚Äôs sleigh","Deliver presents","Sleep in the barn","Wear a bell"], {category:"Santa & Reindeer", template:"premade"}),

  Q("pm_003", "How many ghosts show up in A Christmas Carol (not counting Scrooge)?", "Four",
    ["One","Two","Three","Five"], {category:"Movies", template:"premade"}),

  Q("pm_004", "Where was baby Jesus born?", "Bethlehem",
    ["Nazareth","Jerusalem","Rome","Capernaum"], {category:"Christmas Story", template:"premade"}),

  Q("pm_005", "Miracle on 34th Street is based on a real-life department store. Which one?", "Macy‚Äôs",
    ["Target","Walmart","Nordstrom","Sears"], {category:"Movies", template:"premade"}),

  Q("pm_006", "Which modern-day country was St. Nicholas born in?", "Turkey",
    ["Greece","Italy","France","Spain"], {category:"History", template:"premade"}),

  Q("pm_007", "In It‚Äôs a Wonderful Life, what happens every time a bell rings?", "An angel got his wings",
    ["A candle lights itself","It starts snowing","A door opens","Santa laughs"], {category:"Movies", template:"premade"}),

  Q("pm_008", "In Charles Dickens‚Äôs A Christmas Carol, what was Scrooge‚Äôs first name?", "Ebenezer",
    ["Edward","Eugene","Elijah","Ernest"], {category:"Movies", template:"premade"}),

  Q("pm_009", "Which branch of the U.S. military runs ‚ÄúToys for Tots‚Äù?", "The Marines",
    ["The Navy","The Air Force","The Army","The Coast Guard"], {category:"History", template:"premade"}),

  Q("pm_010", "About 1.3 billion of these are sent each year in the U.S. during Christmas. What are they?", "Christmas cards",
    ["Pumpkins","Fireworks","Valentine hearts","School pencils"], {category:"Traditions", template:"premade"}),

  Q("pm_011", "What do children traditionally get from Santa if they‚Äôre on the ‚ÄúNaughty List‚Äù?", "A lump of coal",
    ["A gold medal","A new bike","A snow globe","A candy cane"], {category:"Santa & Reindeer", template:"premade"}),

  Q("pm_012", "What is the name of Rudolph‚Äôs girlfriend in the classic story?", "Clarice",
    ["Vixen","Dancer","Mittens","Sally"], {category:"Santa & Reindeer", template:"premade"}),

  Q("pm_013", "In A Christmas Story, what is Ralphie‚Äôs little brother‚Äôs name?", "Randy",
    ["Ronnie","Richie","Robby","Ray"], {category:"Movies", template:"premade"}),

  Q("pm_014", "Which country started the tradition of putting up a Christmas tree?", "Germany",
    ["Italy","Spain","Canada","Brazil"], {category:"History", template:"premade"}),

  Q("pm_015", "In Canada, what holiday is celebrated the day after Christmas?", "Boxing Day",
    ["Founders Day","Maple Day","New Year‚Äôs Eve","Remembrance Day"], {category:"History", template:"premade"}),

  Q("pm_016", "In which war did a famous ‚ÄúChristmas Truce‚Äù take place?", "World War I",
    ["World War II","Civil War","Korean War","Vietnam War"], {category:"History", template:"premade"}),

  Q("pm_017", "What‚Äôs the name of the Grinch‚Äôs dog?", "Max",
    ["Buddy","Rudy","Bolt","Rex"], {category:"Movies", template:"premade"}),

  Q("pm_018", "Which action movie set on Christmas Eve is often debated as a Christmas movie?", "Die Hard",
    ["Top Gun","Rocky","Rambo","Speed"], {category:"Movies", template:"premade"}),

  Q("pm_019", "Which meal do people in Japan traditionally eat on Christmas?", "Kentucky Fried Chicken",
    ["Sushi","Ramen","Tempura","Tacos"], {category:"World Traditions", template:"premade"}),

  Q("pm_020", "What is a common name for Christmas trees besides ‚ÄúChristmas tree‚Äù?", "Yule tree",
    ["Pine tower","Holiday bush","Snow shrub","Evergreen wand"], {category:"Traditions", template:"premade"}),

  Q("pm_021", "What decoration was historically made from real silver?", "Tinsel",
    ["Confetti","Ribbon","Garland","Bows"], {category:"Traditions", template:"premade"}),

  Q("pm_022", "Which Christmas ballet premiered in 1892?", "The Nutcracker",
    ["Swan Lake","Cinderella","Sleeping Beauty","Peter Pan"], {category:"History", template:"premade"}),

  Q("pm_023", "Which fairy tale inspired early gingerbread houses?", "Hansel and Gretel",
    ["Cinderella","Jack and the Beanstalk","Rapunzel","Goldilocks"], {category:"History", template:"premade"}),

  Q("pm_024", "In Home Alone, where is the family traveling when Kevin is left behind?", "Paris",
    ["London","Rome","New York","Los Angeles"], {category:"Movies", template:"premade"}),

  Q("pm_025", "In The Polar Express, which actor voices multiple roles?", "Tom Hanks",
    ["Jim Carrey","Will Ferrell","Tim Allen","Adam Sandler"], {category:"Movies", template:"premade"}),

  Q("pm_026", "Which company was an early famous user of Santa in advertising?", "Coca-Cola",
    ["Pepsi","Ford","Nike","LEGO"], {category:"History", template:"premade"}),

  Q("pm_027", "Which Christmas song was originally written for Thanksgiving (later became a holiday song)?", "Jingle Bells",
    ["Silent Night","O Holy Night","The First Noel","Carol of the Bells"], {category:"Songs", template:"premade"}),

  Q("pm_028", "What are three of Santa‚Äôs reindeer names that start with the letter ‚ÄúD‚Äù?", "Dancer, Dasher and Donner",
    ["Cupid, Comet and Clarice","Vixen, Vance and Vito","Blitzen, Buddy and Buster","Prancer, Pouncer and Piper"], {category:"Santa & Reindeer", template:"premade"}),

  Q("pm_029", "In the poem ‚Äú‚ÄòTwas the Night Before Christmas,‚Äù how many reindeer are mentioned?", "Eight",
    ["Six","Seven","Nine","Ten"], {category:"History", template:"premade"}),

  Q("pm_030", "In North America, what‚Äôs another name for wild reindeer?", "Caribou",
    ["Moose","Elk","Bison","Antelope"], {category:"Santa & Reindeer", template:"premade"}),

  Q("pm_031", "What is the name of the last ghost that visits Scrooge?", "The Ghost of Christmas Yet To Come",
    ["The Ghost of Christmas Past","The Ghost of Christmas Present","The Ghost of New Year‚Äôs Day","The Ghost of Halloween"], {category:"Movies", template:"premade"}),

  Q("pm_032", "What food ‚Äúdanced in children‚Äôs heads‚Äù in ‚ÄòTwas the Night Before Christmas?", "Sugar plums",
    ["Candy canes","Apples","Cookies","Hot dogs"], {category:"Traditions", template:"premade"}),

  Q("pm_033", "In Miracle on 34th Street, what is the real store mentioned as part of the story?", "Macy‚Äôs",
    ["Bloomingdale‚Äôs","Target","Walmart","Kohl‚Äôs"], {category:"Movies", template:"premade"}),

  Q("pm_034", "What is the name of George Bailey‚Äôs guardian angel in It‚Äôs a Wonderful Life?", "Clarence Odbody",
    ["Gabriel North","Michael Star","Joseph Holly","Edwin Bell"], {category:"Movies", template:"premade"}),

  Q("pm_035", "In the 1964 Rudolph the Red-Nosed Reindeer, what was the name of Rudolph‚Äôs elf friend?", "Hermey",
    ["Harvey","Henry","Herbie","Herman"], {category:"Movies", template:"premade"}),

  Q("pm_036", "Which family is featured in National Lampoon‚Äôs Christmas Vacation?", "The Griswolds",
    ["The McCallisters","The Parkers","The Baileys","The Browns"], {category:"Movies", template:"premade"}),

  Q("pm_037", "What is a popular horned figure in folklore said to punish naughty children?", "Krampus",
    ["Gryla","Jack Frost","The Yeti","The Sandman"], {category:"Folklore", template:"premade"}),

  Q("pm_038", "What is a traditional hot spiced cider drink enjoyed at winter celebrations?", "Wassail",
    ["Lemonade","Milkshake","Iced tea","Soda pop"], {category:"Food & Treats", template:"premade"}),

  Q("pm_039", "How do you say ‚ÄúMerry Christmas‚Äù in Spanish?", "Feliz Navidad",
    ["Bonjour No√´l","Buon Natale","Frohe Weihnachten","Joyeux P√¢ques"], {category:"Languages", template:"premade"}),

  Q("pm_040", "What is the best-selling Christmas song ever (by recording)?", "White Christmas",
    ["Jingle Bells","Silent Night","Joy to the World","Deck the Halls"], {category:"Songs", template:"premade"})
];

/* ============================
   Clue banks (lots of hardcoded Q/A, single-correct)
   ============================ */
const CLUE_OBJECTS = [
  {id:"ob_eggnog", category:"Food & Treats", answer:"Eggnog", clue:"A creamy holiday drink often served cold and topped with nutmeg."},
  {id:"ob_mistletoe", category:"Traditions", answer:"Mistletoe", clue:"A plant people stand under for a traditional holiday kiss."},
  {id:"ob_wreath", category:"Traditions", answer:"Wreath", clue:"A circular decoration often made of evergreen branches and hung on doors."},
  {id:"ob_stocking", category:"Traditions", answer:"Stocking", clue:"A sock-shaped decoration hung for small gifts."},
  {id:"ob_candycane", category:"Food & Treats", answer:"Candy cane", clue:"A striped peppermint candy shaped like a shepherd‚Äôs staff."},
  {id:"ob_gingerbread", category:"Food & Treats", answer:"Gingerbread", clue:"A spiced cookie often used to build tiny houses."},
  {id:"ob_hotchoc", category:"Food & Treats", answer:"Hot chocolate", clue:"A warm sweet drink often topped with marshmallows."},
  {id:"ob_fruitcake", category:"Food & Treats", answer:"Fruitcake", clue:"A dense cake known for a famously long shelf life."},
  {id:"ob_tinsel", category:"Traditions", answer:"Tinsel", clue:"Shiny strands used on trees, historically made from real silver."},
  {id:"ob_boxing", category:"History", answer:"Boxing Day", clue:"A holiday celebrated the day after Christmas in Canada and the UK."},
  {id:"ob_krampus", category:"Folklore", answer:"Krampus", clue:"A horned folklore figure said to punish naughty children."},
  {id:"ob_nutcracker", category:"History", answer:"The Nutcracker", clue:"A famous ballet from 1892 often performed during the holidays."},
  {id:"ob_yulelog", category:"Traditions", answer:"Yule log", clue:"A traditional log (or cake shaped like one) linked to winter celebrations."},
  {id:"ob_advent", category:"Traditions", answer:"Advent calendar", clue:"A calendar used to count down the days until Christmas."},
  {id:"ob_menorah", category:"General", answer:"Menorah", clue:"A special candle holder used during Hanukkah (often around the holiday season)."},
  {id:"ob_giftwrap", category:"Traditions", answer:"Wrapping paper", clue:"Colorful paper used to cover presents."},
  {id:"ob_ribbon", category:"Traditions", answer:"Ribbon", clue:"A long decorative strip often tied into bows on gifts."},
  {id:"ob_ornament", category:"Traditions", answer:"Ornament", clue:"A decoration hung on a tree (often shiny or colorful)."},
  {id:"ob_star", category:"Traditions", answer:"Star", clue:"A common tree-top decoration that represents the Star of Bethlehem."},
  {id:"ob_angel", category:"Traditions", answer:"An angel", clue:"A common tree-top decoration that represents a heavenly messenger."}
];

const TOY_CLUES = [
  {id:"toy_001", answer:"Tickle Me Elmo", clue:"A hard-to-find 1996 toy featuring a giggling Sesame Street character."},
  {id:"toy_002", answer:"Furby", clue:"A late-1990s electronic pet toy known for speaking its own made-up language."},
  {id:"toy_003", answer:"Tamagotchi", clue:"A pocket-sized digital pet you have to feed and care for."},
  {id:"toy_004", answer:"Cabbage Patch Kids", clue:"A doll line known for unique names and adoption papers."},
  {id:"toy_005", answer:"Beanie Babies", clue:"Small collectible stuffed toys famous for heart-shaped tags."},
  {id:"toy_006", answer:"Rubik's Cube", clue:"A twisting puzzle cube where you try to match colors on each side."},
  {id:"toy_007", answer:"Nintendo Switch", clue:"A game system known for detachable controllers called Joy-Cons."},
  {id:"toy_008", answer:"PlayStation", clue:"A video game console brand known for controllers with symbol buttons (triangle, circle, X, square)."},
  {id:"toy_009", answer:"Xbox", clue:"A video game console brand made by Microsoft."},
  {id:"toy_010", answer:"LEGO", clue:"Plastic building bricks used to build sets like castles, spaceships, and cities."}
];

/* ============================
   Audio & Image placeholders (optional)
   ============================ */
const MEDIA_QUESTIONS = [
  Q("au_001", "AUDIO: Identify this Christmas song from the short clip.", "Jingle Bells",
    ["Silent Night","Deck the Halls","Winter Wonderland","Jingle Bell Rock"],
    {category:"Audio", template:"audio", type:"audio", mediaSrc:"audio/jingle_bells.mp3"}),

  Q("im_001", "IMAGE: Name the movie shown in this picture.", "Home Alone",
    ["Elf","A Christmas Story","The Santa Clause","How the Grinch Stole Christmas"],
    {category:"Images", template:"image", type:"image", mediaSrc:"images/home_alone.jpg"})
];

/* ============================
   Build movie description questions (no title tokens in prompt)
   ============================ */
function buildMovieDescriptionQuestions(){
  const out = [];
  const titles = MOVIE_TITLES.map(m=>m.title);
  for (const m of MOVIE_TITLES){
    const distractors = pick4Distinct(titles.filter(t=>t!==m.title));
    const q = Q(
      m.id,
      `Which Christmas movie fits this description? ${m.clue}`,
      m.title,
      distractors,
      {category:"Movies", template:"movie_desc", avoidAnswerWords:true}
    );
    // enforce: prompt shouldn't contain meaningful title words
    if (!promptContainsAnswerWords(q.prompt, q.answer)) out.push(q);
  }
  return out;
}

/* ============================
   Build clue questions (objects + toys)
   ============================ */
function buildClueQuestions(){
  const out = [];
  const allAnswers = [
    ...CLUE_OBJECTS.map(x=>x.answer),
    ...TOY_CLUES.map(x=>x.answer)
  ];

  for (const item of CLUE_OBJECTS){
    const distractors = pick4Distinct(allAnswers.filter(a=>a!==item.answer).concat([
      "Snow globe","Gingerbread house","Garland","Icicle ornament","Peppermint bark","Candy cane"
    ]));
    out.push(Q(item.id, item.clue, item.answer, distractors, {category:item.category, template:"object_clue"}));
  }

  for (const t of TOY_CLUES){
    const distractors = pick4Distinct(allAnswers.filter(a=>a!==t.answer).concat([
      "Goofy Gus","Wiggling Wralph","Crazy Cookie Monster","Laughing Larry","Robot Raccoon"
    ]));
    out.push(Q(t.id, t.clue, t.answer, distractors, {category:"Famous Gifts", template:"toy_clue"}));
  }

  return out;
}

/* ============================
   Extra solid Q/A (no lyrics, no word-search)
   ============================ */
const EXTRA = [
  Q("ex_001", "What are two popular nicknames for Santa Claus?", "Kris Kringle and Saint Nick",
    ["Father Frost and Snow King","Old Man Winter and Jack Frost","Captain Cheer and Gift Guy","North Nick and Mr. Jolly"], {category:"Santa & Reindeer", template:"extra"}),

  Q("ex_002", "What are the three gifts traditionally brought by the Wise Men?", "Gold, frankincense, and myrrh",
    ["Gold, silver, and bronze","Bread, milk, and honey","Perfume, silk, and spices","Toys, candy, and cookies"], {category:"Christmas Story", template:"extra"}),

  Q("ex_003", "What guided the Wise Men to the newborn Jesus in the Christmas story?", "A star",
    ["A rainbow","A map from Caesar","A dove","A lighthouse"], {category:"Christmas Story", template:"extra"}),

  Q("ex_004", "Where did Mary and Joseph stay the night Jesus was born (according to the story)?", "In a stable (because the inn was full)",
    ["In a palace","In a school","In a temple","In a boat"], {category:"Christmas Story", template:"extra"}),

  Q("ex_005", "What is the name of the green character who tries to ruin Christmas for a town?", "The Grinch",
    ["Frosty","Buddy","Scrooge","Jack Frost"], {category:"Movies", template:"extra"}),

  Q("ex_006", "What do people traditionally hang by the fireplace to fill with small gifts?", "Stocking",
    ["Backpack","Boot","Pillowcase","Hat"], {category:"Traditions", template:"extra"}),

  Q("ex_007", "What is a common thing people do when they find themselves under mistletoe?", "Kiss",
    ["Sing","Dance","Run","Hide"], {category:"Traditions", template:"extra"}),

  Q("ex_008", "In A Christmas Carol, what famous phrase is Scrooge known for saying?", "Bah humbug!",
    ["Ho ho ho!","Merry and bright!","Jingle all the way!","Happy holidays!"], {category:"Movies", template:"extra"}),

  Q("ex_009", "Which movie is often listed as one of the highest-grossing Christmas movies of all time?", "Home Alone",
    ["Klaus","Prancer","Deck the Halls","Arthur Christmas"], {category:"Movies", template:"extra"}),

  Q("ex_010", "What is a common top decoration for a Christmas tree?", "An angel",
    ["A pumpkin","A shoe","A spoon","A baseball"], {category:"Traditions", template:"extra"})
];

/* ============================
   Build the final bank
   ============================ */
function buildBank(){
  const bank = [];
  bank.push(...PREMADE);
  bank.push(...buildMovieDescriptionQuestions());
  bank.push(...buildClueQuestions());
  bank.push(...MEDIA_QUESTIONS);
  bank.push(...EXTRA);

  // Dedup by id
  const seen = new Set();
  const out = [];
  for (const q of bank){
    if (!seen.has(q.id)){
      seen.add(q.id);
      out.push(q);
    }
  }

  return out;
}

let QUESTION_BANK = buildBank();
console.log("Question bank size:", QUESTION_BANK.length);

/* ============================
   Balanced quiz builder (reduces repeats)
   - category rotation
   - template caps
   - no duplicate IDs in a game
   ============================ */
function buildQuizQuestions(){
  const pool = [...QUESTION_BANK];
  shuffle(pool);

  // Bucket by category
  const buckets = new Map();
  for (const q of pool){
    const cat = q.category || "General";
    if (!buckets.has(cat)) buckets.set(cat, []);
    buckets.get(cat).push(q);
  }
  for (const [_, arr] of buckets) shuffle(arr);

  const categoryOrder = [
    "Movies","Songs","Traditions","Food & Treats","Santa & Reindeer","Christmas Story",
    "History","World Traditions","Folklore","Languages","Famous Gifts","Audio","Images","General"
  ];

  const chosen = [];
  const usedIds = new Set();
  const templateCount = new Map();

  function canTake(q){
    if (usedIds.has(q.id)) return false;
    const t = q.template || "misc";
    const count = templateCount.get(t) || 0;
    return count < 7; // cap per template
  }

  let guard = 0;
  while (chosen.length < 30 && guard < 5000){
    guard++;
    const cat = categoryOrder[chosen.length % categoryOrder.length];
    const arr = buckets.get(cat) || [];
    let picked = null;

    while (arr.length){
      const q = arr.pop();
      if (canTake(q)){
        picked = q;
        break;
      }
    }

    if (!picked){
      const remaining = pool.filter(canTake);
      if (!remaining.length) break;
      picked = remaining[Math.floor(Math.random()*remaining.length)];
    }

    chosen.push(picked);
    usedIds.add(picked.id);
    const t = picked.template || "misc";
    templateCount.set(t, (templateCount.get(t)||0) + 1);
  }

  // tie-break buffer
  const extras = pool.filter(q => !usedIds.has(q.id));
  shuffle(extras);
  return chosen.concat(extras.slice(0, 50));
}

/* ============================
   Game Logic / UI
   ============================ */
const $ = (sel)=>document.querySelector(sel);

const screenStart = $("#screenStart");
const screenQuiz = $("#screenQuiz");
const screenEnd = $("#screenEnd");

const pillMode = $("#pillMode");
const pillProgress = $("#pillProgress");
const pillScore = $("#pillScore");
const pillCategory = $("#pillCategory");

const scoreboardWrap = $("#scoreboardWrap");
const scoreboard = $("#scoreboard");

const questionText = $("#questionText");
const mediaEl = $("#media");
const choicesEl = $("#choices");
const feedbackEl = $("#feedback");

const groupControls = $("#groupControls");
const btnReveal = $("#btnReveal");
const btnPass = $("#btnPass");
const btnNext = $("#btnNext");
const buzzButtons = $("#buzzButtons");
const buzzStatus = $("#buzzStatus");
const btnClearBuzz = $("#btnClearBuzz");
const scoreHint = $("#scoreHint");

const btnRestart = $("#btnRestart");
const btnPlayAgain = $("#btnPlayAgain");
const endTitle = $("#endTitle");
const soloEndBlock = $("#soloEndBlock");
const groupEndBlock = $("#groupEndBlock");
const endScore = $("#endScore");
const nameInput = $("#nameInput");
const btnSubmit = $("#btnSubmit");
const submitStatus = $("#submitStatus");
const winnerText = $("#winnerText");
const finalScores = $("#finalScores");

$("#btnSolo").addEventListener("click", ()=>startGame("solo", 1));
$("#btnGroup2").addEventListener("click", ()=>startGame("group", 2));
$("#btnGroup3").addEventListener("click", ()=>startGame("group", 3));
$("#btnGroup4").addEventListener("click", ()=>startGame("group", 4));
btnPlayAgain.addEventListener("click", ()=>goToStart());
btnRestart.addEventListener("click", ()=>goToStart());

let mode = "solo";
let teamCount = 0;
let teamScores = [];
let teamNames = [];
let soloScore = 0;

let gameQuestions = [];
let qIndex = 0;
let isTieBreaker = false;

let choicesRevealed = false;
let buzzedTeam = null;
let buzzWasBeforeReveal = false;

let answeredLocked = false;

function goToStart(){
  stopAnyAudio();
  screenQuiz.style.display = "none";
  screenEnd.style.display = "none";
  screenStart.style.display = "block";
  resetState();
}

function resetState(){
  mode="solo"; teamCount=0;
  teamScores=[]; teamNames=[];
  soloScore=0;
  gameQuestions=[]; qIndex=0; isTieBreaker=false;
  choicesRevealed=false; buzzedTeam=null; buzzWasBeforeReveal=false;
  answeredLocked=false;

  feedbackEl.className="feedback";
  feedbackEl.textContent="";
  feedbackEl.style.display="none";
  scoreHint.style.display="none";
  scoreHint.textContent="";
  submitStatus.style.display="none";
  nameInput.value="";
}

function startGame(newMode, teams){
  resetState();
  mode=newMode;
  teamCount=teams;

  // Balanced pick
  gameQuestions = buildQuizQuestions();
  qIndex = 0;

  screenStart.style.display="none";
  screenEnd.style.display="none";
  screenQuiz.style.display="block";

  pillMode.textContent = `Mode: ${mode==="solo" ? "Solo" : `Group (${teamCount} Teams)`}`;
  pillScore.style.display = (mode==="solo") ? "inline-flex" : "none";

  groupControls.style.display = (mode==="group") ? "grid" : "none";
  scoreboardWrap.style.display = (mode==="group") ? "block" : "none";

  if (mode==="group"){
    teamScores = Array(teamCount).fill(0);
    teamNames = Array.from({length:teamCount}, (_,i)=>`Team ${i+1}`);
    renderScoreboard();
    buildBuzzButtons();
  }

  renderQuestion();
}

function renderScoreboard(){
  scoreboard.innerHTML="";
  for (let i=0;i<teamCount;i++){
    const card=document.createElement("div");
    card.className="teamCard";

    const name=document.createElement("div");
    name.className="teamName";
    name.textContent=teamNames[i];
    name.setAttribute("contenteditable","false");
    name.addEventListener("click", ()=>{name.setAttribute("contenteditable","true"); name.focus();});
    name.addEventListener("blur", ()=>{
      name.setAttribute("contenteditable","false");
      const txt = (name.textContent||"").trim() || `Team ${i+1}`;
      teamNames[i]=txt;
      name.textContent=txt;
      buildBuzzButtons();
    });

    const score=document.createElement("div");
    score.className="teamScore";
    score.id=`teamScore_${i}`;
    score.textContent=String(teamScores[i]);

    const btns=document.createElement("div");
    btns.className="scoreBtns";

    const mk=(label,delta,cls)=> {
      const b=document.createElement("button");
      b.className=cls || "btn small";
      b.textContent=label;
      b.addEventListener("click", ()=>adjustTeamScore(i,delta));
      return b;
    };

    btns.appendChild(mk("+4", +4, "btn small gold"));
    btns.appendChild(mk("+2", +2, "btn small green"));
    btns.appendChild(mk("+1", +1, "btn small"));
    btns.appendChild(mk("-1", -1, "btn small red"));
    btns.appendChild(mk("-2", -2, "btn small red"));

    const mini=document.createElement("div");
    mini.className="mini";
    mini.textContent="Edit name ‚Ä¢ Adjust score";

    card.appendChild(name);
    card.appendChild(score);
    card.appendChild(btns);
    card.appendChild(mini);
    scoreboard.appendChild(card);
  }
}

function adjustTeamScore(teamIdx,delta){
  teamScores[teamIdx]+=delta; // allow negative
  const el=document.getElementById(`teamScore_${teamIdx}`);
  if (el) el.textContent=String(teamScores[teamIdx]);
}

function buildBuzzButtons(){
  buzzButtons.innerHTML="";
  for (let i=0;i<teamCount;i++){
    const b=document.createElement("button");
    b.className="btn small";
    b.textContent=`Buzz: ${teamNames[i]}`;
    b.addEventListener("click", ()=>{
      if (answeredLocked) return;
      buzzedTeam=i;
      buzzWasBeforeReveal=!choicesRevealed;
      buzzStatus.style.display="inline-flex";
      buzzStatus.textContent = `${teamNames[i]} buzzed ${buzzWasBeforeReveal ? "(early = double eligible)" : ""}`;
      btnClearBuzz.style.display="inline-flex";
      scoreHint.style.display="none";
    });
    buzzButtons.appendChild(b);
  }
  btnClearBuzz.style.display = (buzzedTeam!==null) ? "inline-flex" : "none";
  btnClearBuzz.onclick=()=>{
    buzzedTeam=null; buzzWasBeforeReveal=false;
    buzzStatus.style.display="none";
    btnClearBuzz.style.display="none";
  };
}

btnReveal.addEventListener("click", ()=>{
  if (answeredLocked) return;
  choicesRevealed = !choicesRevealed;
  if (choicesRevealed){
    btnReveal.textContent="Hide Choices";
    choicesEl.style.display="grid";
  } else {
    btnReveal.textContent="Reveal Choices";
    choicesEl.style.display="none";
  }
});

btnPass.addEventListener("click", ()=>{
  if (answeredLocked) return;
  showFeedback("Pass. Nobody answered. Moving on.", "bad");
  btnNext.disabled=false;
});

btnNext.addEventListener("click", ()=>nextQuestion());

function renderQuestion(){
  answeredLocked=false;
  btnNext.disabled=true;
  scoreHint.style.display="none";
  scoreHint.textContent="";

  feedbackEl.className="feedback";
  feedbackEl.textContent="";
  feedbackEl.style.display="none";

  stopAnyAudio();

  const mainTotal=30;
  pillProgress.textContent = `Q ${Math.min(qIndex+1,mainTotal)} / ${mainTotal}` + (isTieBreaker ? " (Tie-breaker)" : "");
  pillScore.textContent = `Score: ${soloScore}`;

  const q=gameQuestions[qIndex];
  pillCategory.textContent = `Category: ${q.category}`;
  questionText.textContent = q.prompt;

  // media
  mediaEl.innerHTML="";
  if (q.type==="image" && q.mediaSrc){
    const img=document.createElement("img");
    img.src=q.mediaSrc;
    img.alt="Question image";
    mediaEl.appendChild(img);
  } else if (q.type==="audio" && q.mediaSrc){
    const a=document.createElement("audio");
    a.controls=true;
    a.preload="none";
    a.src=q.mediaSrc;
    mediaEl.appendChild(a);
  }

  // choices
  const options = buildFiveChoices(q);
  renderChoices(options, q.answer);

  if (mode==="solo"){
    choicesEl.style.display="grid";
  } else {
    choicesRevealed=false;
    btnReveal.textContent="Reveal Choices";
    choicesEl.style.display="none";

    buzzedTeam=null;
    buzzWasBeforeReveal=false;
    buzzStatus.style.display="none";
    btnClearBuzz.style.display="none";
  }
}

function buildFiveChoices(q){
  const set=new Set([q.answer]);
  const d=[...q.distractors];
  shuffle(d);
  for (const x of d){
    if (set.size>=5) break;
    set.add(x);
  }
  if (set.size<5){
    const global = QUESTION_BANK.map(qq=>qq.answer).filter(a=>a && a!==q.answer);
    shuffle(global);
    for (const g of global){
      if (set.size>=5) break;
      set.add(g);
    }
  }
  const arr=Array.from(set);
  shuffle(arr);
  return arr.slice(0,5);
}

function renderChoices(options, correct){
  choicesEl.innerHTML="";
  for (const opt of options){
    const div=document.createElement("div");
    div.className="choice";
    div.textContent=opt;
    div.addEventListener("click", ()=>onChoose(opt, correct, div));
    choicesEl.appendChild(div);
  }
}

function onChoose(selected, correct, el){
  if (answeredLocked) return;

  if (mode==="group" && !choicesRevealed){
    showFeedback("Reveal choices first (so you can verify the spoken answer).", "bad");
    return;
  }

  answeredLocked=true;
  [...choicesEl.children].forEach(c=>{
    c.classList.add("disabled");
    c.style.pointerEvents="none";
  });

  const isCorrect = (selected===correct);

  [...choicesEl.children].forEach(c=>{
    if (c.textContent===correct) c.classList.add("correct");
  });
  if (!isCorrect) el.classList.add("wrong");

  if (mode==="solo"){
    soloScore += isCorrect ? 2 : -1;
    pillScore.textContent=`Score: ${soloScore}`;

    showFeedback(
      isCorrect ? "‚úÖ Correct! +2" : `‚ùå Incorrect. Correct answer: "${correct}" (-1)`,
      isCorrect ? "good" : "bad"
    );

    setTimeout(()=>nextQuestion(), 3200);
  } else {
    const suggested = isCorrect
      ? ((buzzedTeam!==null && buzzWasBeforeReveal) ? 4 : 2)
      : -1;

    const buzzTxt = (buzzedTeam!==null) ? `Buzzed team: ${teamNames[buzzedTeam]}.` : "No team buzzed.";
    const sugTxt = `Suggested score: ${suggested>=0?"+":""}${suggested}${(suggested===4?" (double)":"")}.`;

    showFeedback(
      (isCorrect ? "‚úÖ Correct." : `‚ùå Incorrect. Correct answer: "${correct}".`) + " " + buzzTxt + " " + sugTxt + " Click Next.",
      isCorrect ? "good" : "bad"
    );

    scoreHint.style.display="block";
    scoreHint.textContent=sugTxt;
    btnNext.disabled=false;
  }
}

function showFeedback(text,kind){
  feedbackEl.textContent=text;
  feedbackEl.className="feedback show " + (kind==="good" ? "good" : "bad");
  feedbackEl.style.display="block";
}

function nextQuestion(){
  qIndex++;

  if (!isTieBreaker && qIndex>=30){
    if (mode==="solo") return endSolo();
    const {max,winners}=getLeaders();
    if (winners.length===1) return endGroup();
    isTieBreaker=true;
    showFeedback(`Tie at ${max} points between: ${winners.map(i=>teamNames[i]).join(", ")}. Sudden death begins.`, "bad");
  }

  if (isTieBreaker && mode==="group"){
    const {winners}=getLeaders();
    if (winners.length===1) return endGroup();
  }

  if (qIndex>=gameQuestions.length){
    // replenish buffer if needed
    const more = buildQuizQuestions().slice(0,50);
    gameQuestions = gameQuestions.concat(more);
  }

  renderQuestion();
}

function getLeaders(){
  const max=Math.max(...teamScores);
  const winners=[];
  teamScores.forEach((s,i)=>{if (s===max) winners.push(i);});
  return {max,winners};
}

function endSolo(){
  stopAnyAudio();
  screenQuiz.style.display="none";
  screenEnd.style.display="block";

  endTitle.textContent="Solo Game Complete!";
  soloEndBlock.style.display="block";
  groupEndBlock.style.display="none";
  endScore.textContent=`Score: ${soloScore}`;
  submitStatus.style.display="none";
}

function endGroup(){
  stopAnyAudio();
  screenQuiz.style.display="none";
  screenEnd.style.display="block";

  endTitle.textContent="Group Game Complete!";
  soloEndBlock.style.display="none";
  groupEndBlock.style.display="block";

  const {max,winners}=getLeaders();
  winnerText.textContent = winners.length===1
    ? `üèÜ ${teamNames[winners[0]]} won with ${max} points!`
    : `ü§ù Tie at ${max}: ${winners.map(i=>teamNames[i]).join(", ")}`;

  finalScores.innerHTML =
    `<h3 style="margin:.2rem 0 .6rem">Final Scores</h3>` +
    `<div class="pillbar" style="justify-content:flex-start">` +
    teamScores.map((s,i)=>`<span class="pill"><b>${escapeHtml(teamNames[i])}</b>: ${s}</span>`).join("") +
    `</div>`;
}

/* Solo score submit */
btnSubmit.addEventListener("click", async ()=>{
  const name=(nameInput.value||"").trim();
  if (!name){
    submitStatus.style.display="inline-flex";
    submitStatus.textContent="Please enter your name.";
    return;
  }
  const timeISO=new Date().toISOString();
  submitStatus.style.display="inline-flex";
  submitStatus.textContent="Submitting score...";

  const url = `${SCRIPT_URL}?Name=${encodeURIComponent(name)}&Time=${encodeURIComponent(timeISO)}&Score=${encodeURIComponent(String(soloScore))}`;
  try{
    await fetch(url, {mode:"no-cors"});
    submitStatus.textContent="Submitted! üéâ (If it doesn‚Äôt show instantly, refresh the sheet.)";
  }catch(e){
    submitStatus.textContent="Submission failed. Check your Apps Script deployment settings.";
  }
});

goToStart();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Christmas Trivia Game</title>
  <style>
    /* Basic Reset and Body Styling */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: #001a33 url('') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      overflow-x: hidden;
    }
    h1, h2, h3 {
      font-family: "Mountains of Christmas", cursive, sans-serif;
      margin: 0.2em;
    }
    a {
      color: #0ff;
    }
    /* Container for different screens */
    #start-screen, #quiz-screen, #end-screen {
      display: none;
      padding: 2rem 1rem;
      max-width: 800px;
      margin: auto;
    }
    /* Visible by default: start screen */
    #start-screen {
      display: block;
    }
    /* Buttons */
    button {
      font: inherit;
      padding: 0.6em 1.2em;
      margin: 0.5em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 5px #000;
    }
    button:focus {
      outline: 2px solid #fff;
    }
    /* Mode selection buttons */
    .mode-btn {
      background-color: #28a745; /* green */
      color: #fff;
    }
    .mode-btn:hover {
      background-color: #218838;
    }
    /* Reveal and Pass buttons in group mode */
    #reveal-btn, #pass-btn {
      background-color: #17a2b8; /* teal */
      color: #fff;
    }
    #reveal-btn:hover, #pass-btn:hover {
      background-color: #138496;
    }
    /* Choice buttons (multiple choice answers) */
    .choice-btn {
      display: block;
      width: 100%;
      max-width: 400px;
      margin: 0.25em auto;
      background: #ffc107; /* gold */
      color: #000;
      text-align: left;
      padding: 0.5em 1em;
    }
    .choice-btn:hover {
      background: #e0a800;
    }
    .choice-btn.correct {
      background: #28a745 !important; /* green */
      color: #fff;
    }
    .choice-btn.wrong {
      background: #dc3545 !important; /* red */
      color: #fff;
    }
    /* Scoreboard for group mode */
    #scoreboard {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin: 1em 0;
    }
    .team {
      background: rgba(0,0,0,0.3);
      border: 2px solid #fff;
      border-radius: 5px;
      padding: 0.5em 1em;
      margin: 0.5em;
      min-width: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .team-name {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 0.2em;
      /* Make team name editable for customization */
      cursor: pointer;
    }
    .team-name[contenteditable]:focus {
      outline: 2px dashed #fff;
    }
    .score-controls {
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .score-controls button {
      background: #0069d9;
      color: #fff;
      font-size: 1.2em;
      width: 2em;
      height: 2em;
      padding: 0;
    }
    .score-controls button:hover {
      background: #0053aa;
    }
    .team-score {
      font-size: 1.3em;
      min-width: 2ch;
      text-align: center;
    }
    /* Question display area */
    #question-number {
      font-weight: normal;
      font-size: 1.1em;
      margin-bottom: 0.5em;
    }
    #question-text {
      font-size: 1.3em;
      margin: 0.5em 0 1em;
    }
    #media-container {
      margin: 1em 0;
    }
    #media-container img,
    #media-container audio {
      max-width: 100%;
      max-height: 300px;
    }
    /* End screen */
    #final-score {
      font-size: 1.5em;
      margin: 0.5em 0 1em;
    }
    #submit-form {
      margin: 1em 0;
    }
    #player-name {
      padding: 0.4em;
      font-size: 1em;
      width: 60%;
      max-width: 300px;
      border-radius: 5px;
      border: 2px solid #ccc;
      text-align: center;
    }
    #submit-score-btn {
      background: #28a745;
      color: #fff;
    }
    #submit-score-btn:hover {
      background: #218838;
    }
    #tie-message {
      font-weight: bold;
      color: #ffecb3;
      display: none;
      margin-top: 0.5em;
    }
    /* Snow animation styles (from CSSnowflakes, MIT License) */
    .snowflakes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }
    .snowflake {
      position: fixed;
      top: -10%;
      user-select: none;
      pointer-events: none;
      color: #fff;
      font-size: 1.2em;
      text-shadow: 0 0 5px #fff;
      animation-name: snow-fall, snow-shake;
      animation-duration: 10s, 3s;
      animation-timing-function: linear, ease-in-out;
      animation-iteration-count: infinite, infinite;
    }
    @keyframes snow-fall {
      0% { top: -10%; }
      100% { top: 100%; }
    }
    @keyframes snow-shake {
      0%, 100% { transform: translateX(0); }
      50% { transform: translateX(80px); }
    }
    .snowflake:nth-of-type(1) { left: 1%; animation-delay: 0s, 0s; }
    .snowflake:nth-of-type(2) { left: 10%; animation-delay: 1s, 1s; }
    .snowflake:nth-of-type(3) { left: 20%; animation-delay: 6s, 2s; }
    .snowflake:nth-of-type(4) { left: 30%; animation-delay: 3s, 0s; }
    .snowflake:nth-of-type(5) { left: 40%; animation-delay: 8s, 1s; }
    .snowflake:nth-of-type(6) { left: 50%; animation-delay: 5s, 2s; }
    .snowflake:nth-of-type(7) { left: 60%; animation-delay: 2s, 0s; }
    .snowflake:nth-of-type(8) { left: 70%; animation-delay: 7s, 1s; }
    .snowflake:nth-of-type(9) { left: 80%; animation-delay: 4s, 2s; }
    .snowflake:nth-of-type(10) { left: 90%; animation-delay: 9s, 0s; }
  </style>
</head>
<body>
  <!-- Snowflake elements for falling snow effect -->
  <div class="snowflakes" aria-hidden="true">
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÖ</div>
  </div>

  <!-- Start Screen -->
  <div id="start-screen">
    <h1>üéÑ Christmas Trivia Game üéÑ</h1>
    <h3>Select a mode to play:</h3>
    <button class="mode-btn" id="solo-btn">Solo Play</button>
    <button class="mode-btn" id="group-btn-2">Group Play (2 Teams)</button>
    <button class="mode-btn" id="group-btn-3">Group Play (3 Teams)</button>
    <button class="mode-btn" id="group-btn-4">Group Play (4 Teams)</button>
  </div>

  <!-- Quiz Screen (Solo or Group) -->
  <div id="quiz-screen">
    <!-- Scoreboard for group mode (hidden in solo) -->
    <div id="scoreboard"></div>
    <!-- Tie-breaker message -->
    <div id="tie-message">Tie! Entering tie-breaker round...</div>
    <!-- Question area -->
    <div id="question-number"></div>
    <div id="question-text"></div>
    <div id="media-container"></div>
    <!-- Multiple-choice options -->
    <div id="choices-container"></div>
    <!-- Group mode control buttons -->
    <div id="group-controls">
      <button id="reveal-btn">Reveal Choices</button>
      <button id="pass-btn">Pass</button>
    </div>
  </div>

  <!-- End Screen -->
  <div id="end-screen">
    <h2 id="end-title"></h2>
    <div id="final-score"></div>
    <div id="winner-message"></div>
    <!-- Solo mode score submission form -->
    <div id="submit-form">
      <input type="text" id="player-name" placeholder="Your Name" maxlength="50" />
      <button id="submit-score-btn">Submit Score</button>
    </div>
    <p id="submit-status"></p>
    <button id="play-again-btn">Play Again</button>
  </div>

  <script>
    /* Question Pool Data: An array of question objects with properties:
       - question: string
       - answer: string (correct answer)
       - audio: (optional) URL of audio clip
       - image: (optional) URL of image
    */
    const questions = <!-- Begin Questions Array --> 
    <?php /* For demonstration only: to ensure script runs, replaced actual JSON with placeholder in PHP block to avoid extremely long code injection. In actual final answer, the JSON data from final_json would be placed here. */ ?>
    <!-- End Questions Array -->;

    // Game state variables
    let currentQuestionIndex = 0;
    let soloScore = 0;
    let gameMode = ""; // "solo" or "group"
    let totalQuestions = 30;
    let teamCount = 0;
    let teamScores = [];
    let tieBreak = false;

    // DOM elements
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const endScreen = document.getElementById('end-screen');
    const scoreboardDiv = document.getElementById('scoreboard');
    const questionNumberDiv = document.getElementById('question-number');
    const questionTextDiv = document.getElementById('question-text');
    const mediaContainer = document.getElementById('media-container');
    const choicesContainer = document.getElementById('choices-container');
    const groupControls = document.getElementById('group-controls');
    const revealBtn = document.getElementById('reveal-btn');
    const passBtn = document.getElementById('pass-btn');
    const tieMessage = document.getElementById('tie-message');
    const endTitle = document.getElementById('end-title');
    const finalScoreDiv = document.getElementById('final-score');
    const winnerMessage = document.getElementById('winner-message');
    const submitForm = document.getElementById('submit-form');
    const playerNameInput = document.getElementById('player-name');
    const submitScoreBtn = document.getElementById('submit-score-btn');
    const submitStatus = document.getElementById('submit-status');
    const playAgainBtn = document.getElementById('play-again-btn');

    // Buttons for mode selection
    document.getElementById('solo-btn').addEventListener('click', () => startGame("solo"));
    document.getElementById('group-btn-2').addEventListener('click', () => startGame("group", 2));
    document.getElementById('group-btn-3').addEventListener('click', () => startGame("group", 3));
    document.getElementById('group-btn-4').addEventListener('click', () => startGame("group", 4));

    // Reveal and Pass events (group mode)
    revealBtn.addEventListener('click', () => {
      // Toggle choices visibility
      if (choicesContainer.style.display === "none") {
        revealBtn.textContent = "Hide Choices";
        showChoices();
      } else {
        revealBtn.textContent = "Reveal Choices";
        choicesContainer.style.display = "none";
      }
    });
    passBtn.addEventListener('click', () => {
      if (gameMode === "group") {
        nextQuestion();
      }
    });

    // End screen events
    submitScoreBtn.addEventListener('click', submitScore);
    playAgainBtn.addEventListener('click', resetGame);

    // Initialize scoreboard team name editing
    scoreboardDiv.addEventListener('click', e => {
      if (e.target.classList.contains('team-name')) {
        // Make team name editable on click
        e.target.setAttribute('contenteditable', 'true');
        e.target.focus();
      }
    });
    scoreboardDiv.addEventListener('blur', e => {
      if (e.target.classList.contains('team-name')) {
        // Stop editing on blur
        e.target.removeAttribute('contenteditable');
      }
    }, true);

    function startGame(mode, teams = 0) {
      gameMode = mode;
      // Hide start, show quiz
      startScreen.style.display = "none";
      quizScreen.style.display = "block";
      endScreen.style.display = "none";
      // Initialize game state
      currentQuestionIndex = 0;
      soloScore = 0;
      tieBreak = false;
      // Shuffle and select 30 random questions for this game
      gameQuestions = [...questions];  // copy
      shuffleArray(gameQuestions);
      gameQuestions = gameQuestions.slice(0, totalQuestions);
      // If group mode, add additional questions for potential tie-breakers:
      if (gameMode === "group") {
        // We will use extra questions beyond the first 30 if needed in tie-break
        // Ensure we have a few extra in gameQuestions (for safety, take 5 extra)
        const extraQuestions = questions.filter(q => !gameQuestions.includes(q));
        shuffleArray(extraQuestions);
        gameQuestions = gameQuestions.concat(extraQuestions.slice(0, 5));
      }
      // Setup scoreboard for group mode
      if (gameMode === "group") {
        teamCount = teams;
        teamScores = Array(teamCount).fill(0);
        renderScoreboard();
        scoreboardDiv.style.display = "flex";
        groupControls.style.display = "block";
      } else {
        scoreboardDiv.style.display = "none";
        groupControls.style.display = "none";
      }
      // Show first question
      displayQuestion();
    }

    function displayQuestion() {
      // Clear any feedback or media from previous question
      tieMessage.style.display = "none";
      questionNumberDiv.textContent = `Question ${currentQuestionIndex + 1} of ${totalQuestions}` + (tieBreak ? " (Tie-breaker)" : "");
      const qObj = gameQuestions[currentQuestionIndex];
      questionTextDiv.textContent = qObj.question;
      // Handle media: image or audio if present
      mediaContainer.innerHTML = "";
      if (qObj.image) {
        const img = document.createElement('img');
        img.src = qObj.image;
        img.alt = "Question image";
        mediaContainer.appendChild(img);
      }
      if (qObj.audio) {
        const audioElem = document.createElement('audio');
        audioElem.src = qObj.audio;
        audioElem.controls = true;
        mediaContainer.appendChild(audioElem);
      }
      // If group mode, hide choices initially
      if (gameMode === "group") {
        choicesContainer.style.display = "none";
        revealBtn.textContent = "Reveal Choices";
      } else {
        choicesContainer.style.display = "block";
      }
      // Populate choices (for solo immediately, for group on reveal)
      if (gameMode === "solo") {
        showChoices();
      } else {
        // Prepare choices but keep hidden (will be shown on reveal)
        prepareChoices();
      }
    }

    // Prepare the multiple-choice buttons for the current question
    let currentChoices = []; // store the current set of answer choices
    function prepareChoices() {
      choicesContainer.innerHTML = "";
      currentChoices = [];
      const qObj = gameQuestions[currentQuestionIndex];
      const correctAnswer = qObj.answer;
      // Determine if True/False question:
      const isTrueFalse = /^True or False/i.test(qObj.question) || 
                           (correctAnswer.toLowerCase() === "true" || correctAnswer.toLowerCase() === "false");
      let options;
      if (isTrueFalse) {
        options = ["True", "False"];
      } else {
        // Generate 4 options: correct + 3 random wrong
        options = [correctAnswer];
        // Collect wrong answers that are not the same as correct
        const wrongPool = allAnswers.filter(ans => ans !== correctAnswer);
        shuffleArray(wrongPool);
        // Pick first 3 unique wrong answers
        for (let i = 0; i < wrongPool.length && options.length < 4; i++) {
          const candidate = wrongPool[i];
          // Avoid trivial wrong options like "True"/"False" as distractors for non-True/False questions
          if (candidate.toLowerCase() === "true" || candidate.toLowerCase() === "false") {
            continue;
          }
          options.push(candidate);
        }
        options = options.slice(0, 4);
      }
      shuffleArray(options);
      // Create buttons for each option
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = "choice-btn";
        btn.textContent = opt;
        btn.onclick = () => handleChoice(opt, btn);
        choicesContainer.appendChild(btn);
        currentChoices.push(btn);
      });
    }

    function showChoices() {
      // Ensure choices prepared
      if (!currentChoices.length) {
        prepareChoices();
      }
      choicesContainer.style.display = "block";
    }

    function handleChoice(selectedAnswer, buttonElement) {
      const qObj = gameQuestions[currentQuestionIndex];
      const correctAnswer = qObj.answer;
      // Disable all choice buttons to prevent multiple answers
      currentChoices.forEach(btn => btn.disabled = true);
      if (selectedAnswer === correctAnswer) {
        // Correct choice
        buttonElement.classList.add('correct');
        if (gameMode === "solo") {
          soloScore += 2;
        }
      } else {
        // Wrong choice
        buttonElement.classList.add('wrong');
        // Highlight the correct answer
        const correctBtn = currentChoices.find(btn => btn.textContent === correctAnswer);
        if (correctBtn) correctBtn.classList.add('correct');
        if (gameMode === "solo") {
          soloScore -= 1;
        }
      }
      if (gameMode === "solo") {
        // Wait 3 seconds, then go to next question or end
        setTimeout(nextQuestion, 3000);
      }
      // In group mode, the host will manually score via scoreboard. They can then hit "Pass" or this question's choices can remain visible.
      // (No auto-advance in group mode; advancing only on "Pass" or after manual scoring and possibly clicking "Reveal" again.)
    }

    function nextQuestion() {
      currentQuestionIndex++;
      if (gameMode === "group" && currentQuestionIndex === totalQuestions) {
        // After 30 questions in group mode, decide if tie-break needed
        const maxScore = Math.max(...teamScores);
        const topTeams = teamScores.filter(s => s === maxScore).length;
        if (topTeams > 1) {
          // Tie among top teams -> continue tie-breaker questions
          tieBreak = true;
          tieMessage.style.display = "block";
        } else {
          // We have a clear winner, end game
          return endGame();
        }
      }
      if (gameMode === "solo" && currentQuestionIndex === totalQuestions) {
        // Solo mode end
        return endGame();
      }
      if (currentQuestionIndex < gameQuestions.length) {
        displayQuestion();
      } else {
        // If we exhausted question list (should not normally happen), end game
        endGame();
      }
    }

    function endGame() {
      quizScreen.style.display = "none";
      endScreen.style.display = "block";
      // Determine end screen content based on mode
      if (gameMode === "solo") {
        endTitle.textContent = "Quiz Complete!";
        finalScoreDiv.textContent = "Your Final Score: " + soloScore;
        winnerMessage.textContent = "";
        submitForm.style.display = "block";
        submitStatus.textContent = "";
      } else if (gameMode === "group") {
        endTitle.textContent = "Game Over!";
        // Determine winners
        const maxScore = Math.max(...teamScores);
        const winners = [];
        teamScores.forEach((score, idx) => {
          if (score === maxScore) winners.push(teamNames[idx] || `Team ${idx+1}`);
        });
        if (winners.length === 1) {
          winnerMessage.textContent = "üéâ Winner: " + winners[0] + " üéâ";
        } else if (winners.length > 1) {
          winnerMessage.textContent = "It's a tie between: " + winners.join(", ");
        }
        finalScoreDiv.textContent = "";
        submitForm.style.display = "none";
        submitStatus.textContent = "";
      }
    }

    function resetGame() {
      // Reset and go back to start screen
      endScreen.style.display = "none";
      startScreen.style.display = "block";
      // Clear dynamic elements
      scoreboardDiv.innerHTML = "";
      questionTextDiv.textContent = "";
      mediaContainer.innerHTML = "";
      choicesContainer.innerHTML = "";
      teamScores = [];
      teamNames = [];
    }

    // Scoreboard rendering for group mode
    let teamNames = [];
    function renderScoreboard() {
      scoreboardDiv.innerHTML = "";
      teamNames = [];
      for (let i = 0; i < teamCount; i++) {
        const teamDiv = document.createElement('div');
        teamDiv.className = "team";
        const nameDiv = document.createElement('div');
        nameDiv.className = "team-name";
        nameDiv.textContent = "Team " + (i+1);
        teamNames.push(nameDiv.textContent);
        const scoreDiv = document.createElement('div');
        scoreDiv.className = "team-score";
        scoreDiv.textContent = teamScores[i];
        const controlsDiv = document.createElement('div');
        controlsDiv.className = "score-controls";
        const incBtn = document.createElement('button');
        incBtn.textContent = "+";
        const decBtn = document.createElement('button');
        decBtn.textContent = "‚Äì";
        // Attach event handlers for score adjust
        incBtn.onclick = () => { teamScores[i]++; scoreDiv.textContent = teamScores[i]; };
        decBtn.onclick = () => { teamScores[i] = Math.max(0, teamScores[i]-1); scoreDiv.textContent = teamScores[i]; };
        controlsDiv.appendChild(decBtn);
        controlsDiv.appendChild(scoreDiv);
        controlsDiv.appendChild(incBtn);
        teamDiv.appendChild(nameDiv);
        teamDiv.appendChild(controlsDiv);
        scoreboardDiv.appendChild(teamDiv);
      }
    }

    // Shuffle utility for arrays
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // Submission of score to Google Sheet (Solo mode)
    const SCRIPT_URL = "YOUR_APPS_SCRIPT_WEB_APP_URL_HERE";
    function submitScore() {
      const playerName = playerNameInput.value.trim();
      if (!playerName) {
        submitStatus.style.color = "#f00";
        submitStatus.textContent = "Please enter your name to submit.";
        return;
      }
      // Prepare data
      const score = soloScore;
      const timestamp = new Date().toISOString();
      submitStatus.style.color = "#fff";
      submitStatus.textContent = "Submitting score...";
      // Send to Google Apps Script Web App (as GET request, no-cors)
      fetch(`${SCRIPT_URL}?Name=${encodeURIComponent(playerName)}&Score=${score}&Time=${encodeURIComponent(timestamp)}`, {
        mode: 'no-cors'
      }).then(() => {
        submitStatus.style.color = "#0f0";
        submitStatus.textContent = "Score submitted! üéâ";
      }).catch(() => {
        submitStatus.style.color = "#ffa";
        submitStatus.textContent = "Submission failed (please check your internet or script URL)";
      });
    }
  </script>
</body>
</html>
